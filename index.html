<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ¥­å‹™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font-small: 11px;
    --font-medium: 13px;
    --font-large: 15px;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f5f5f5;
    color: #111;
    line-height: 1.6;
    font-size: var(--font-small);  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå° */
  }

  /* â˜… æœ¬æ–‡ã ã‘ã‚µã‚¤ã‚ºå¯å¤‰ã«ã™ã‚‹ */
  main {
    font-size: var(--font-small);  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šå° */
  }
  body.font-medium main {
    font-size: var(--font-medium);
  }
  body.font-large main {
    font-size: var(--font-large);
  }

  /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ã®æ–‡å­—ã‚µã‚¤ã‚ºã‚‚é€£å‹•ã•ã›ã‚‹ */
  body.font-medium .app-menu-sheet {
    font-size: var(--font-medium);
  }
  body.font-large .app-menu-sheet {
    font-size: var(--font-large);
  }

  /* ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 12px;
  }
  .login-wrap {
    width: 100%;
    max-width: 360px;
    background: #fff;
    border-radius: 12px;
    padding: 20px 18px 18px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  }
  .login-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 6px;
  }
  .login-subtitle {
    font-size: 13px;
    color: #555;
    margin-bottom: 12px;
  }
  .login-field {
    margin-bottom: 10px;
  }
  .login-field label {
    display: block;
    font-size: 12px;
    color: #555;
    margin-bottom: 2px;
  }
  .login-field input {
    width: 100%;
    padding: 7px 9px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 13px;
  }
  .login-actions {
    margin-top: 8px;
    margin-bottom: 8px;
  }
  #loginBtn {
    width: 100%;
    border: none;
    border-radius: 999px;
    padding: 8px 0;
    font-size: 14px;
    font-weight: 600;
    background: #111;
    color: #fff;
    cursor: pointer;
  }
  #loginBtn:hover {
    background: #333;
  }
  .login-note {
    font-size: 11px;
    color: #777;
    line-height: 1.5;
  }

  .app {
    max-width: 1400px;
    margin: 0 auto;
    padding-bottom: 80px;
    display: none;  /* â† æœ€åˆã¯éè¡¨ç¤ºã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤ºã™ã‚‹ */
  }

  /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
  .top-bar {
    position: sticky;
    top: 0;
    z-index: 4000;
    background: #111;
    color: #fff;
    padding: 10px 14px 8px;
  }

  .app-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .top-bar h1 {
    font-size: 1.45em;
    font-weight: 600;
  }

  .top-bar p {
    font-size: 1em;
    opacity: 0.85;
    margin-top: 2px;
  }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå…±é€šï¼‰ */
  .app-menu-btn {
    border: none;
    background: transparent;
    padding: 4px;
    border-radius: 999px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .app-menu-btn:hover {
    background: rgba(255,255,255,0.08);
  }

  /* ä¸‰æœ¬ç·šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
  .hamburger-icon {
    display: inline-flex;
    flex-direction: column;
    gap: 3px;
    padding: 4px 2px;
  }

  .hamburger-icon span {
    display: block;
    width: 18px;
    height: 2px;
    border-radius: 999px;
    background: #fff;   /* é»’ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸Šã§ç™½ã„ç·š */
  }


  /* ãƒŠãƒ“ï¼ˆæ™‚é–“å¸¯ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ */
  .nav {
    display: none !important;   /* â† ã“ã“ã« !important è¿½åŠ ï¼ */
    overflow-x: auto;
    gap: 6px;
    padding: 8px 2px 4px;
    margin-top: 8px;
    scrollbar-width: none;
  }
  .nav::-webkit-scrollbar { display: none; }
  .nav a {
    flex: 0 0 auto;
    padding: 4px 8px;
    font-size: 1em;
    border-radius: 999px;
    border: 1px solid #555;
    color: #eee;
    text-decoration: none;
    white-space: nowrap;
  }
  .nav a:hover {
    background: #fff;
    color: #111;
  }

  /* æ–‡å­—ã‚µã‚¤ã‚ºåˆ‡ã‚Šæ›¿ãˆãƒãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å†…ï¼‰ */
  .font-size-selector {
    display: none;
    gap: 6px;
    padding: 6px 0 2px;
  }
  .font-size-selector button,
  .btn-secondary {
    padding: 3px 10px;
    font-size: 0.95em;
    background: #222;
    border: 1px solid #555;
    border-radius: 999px;
    color: #eee;
    cursor: pointer;
  }
  .font-size-selector button:hover,
  .btn-secondary:hover {
    background: #444;
  }
  .font-size-selector button.active,
  .btn-secondary.active {
    background: #fff;
    color: #111;
    border-color: #fff;
  }

  .btn-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }

  main { padding: 10px 12px 20px; }

  /* ===== ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ™‚é–“å¸¯ã‚«ãƒ¼ãƒ‰ï¼‰å‘¨ã‚Š ===== */
  .slot {
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    padding: 10px 10px 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  }

  .slot-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }
  .slot-title {
    font-size: 1.27em;
    font-weight: 600;
  }
    
  /* é€šå¸¸ã®æ™‚é–“å¸¯ã‚«ãƒ¼ãƒ‰ã®å³å´ãƒ©ãƒ™ãƒ«ã‚’æ¶ˆã™ */  
  .slot-note {
    font-size: 0.9em;
    color: #666;
    display: none;          /* â† ã“ã‚Œè¿½åŠ ï¼ */
  }

  .tasks-group {
    margin-top: 6px;
  }
  .tasks-group h3 {
    font-size: 1.1em;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }
  .badge {
    font-size: 0.9em;
    padding: 1px 6px;
    border-radius: 999px;
  }
  .badge-a { background: #111; color: #fff; }
  .badge-b { background: #e0e0e0; color: #333; }

  ul.tasks {
    list-style: none;
    padding-left: 10px;
    border-left: 2px solid #111;
    margin-bottom: 4px;
  }
  ul.tasks.b { border-left-color: #bbb; }

  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    font-size: 1em;
    padding: 2px 0;
  }
  .task-item input[type="checkbox"] {
    margin-top: 2px;
  }
  .task-text { flex: 1; }

  .footer-note {
    font-size: 0.9em;
    color: #666;
    padding: 6px 4px 20px;
    text-align: center;
  }

  /* ===== ãŠçŸ¥ã‚‰ã›ãƒ»å¼•ãç¶™ãç”¨ ===== */
  .info-list {
    list-style: none;
    font-size: 1em;
    padding-left: 4px;
  }
  .info-list li {
    padding: 2px 0;
  }

  .handover {
    margin-top: 4px;
  }
  .handover-title {
    font-size: 1.18em;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .handover-note {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 4px;
  }

  .handover-log {
    list-style: none;
    font-size: 1em;
    border-top: 1px dashed #ddd;
    padding-top: 4px;
  }
  .handover-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
  }
  .handover-text {
    flex: 1;
    margin-right: 6px;
  }
  .handover-time {
    font-size: 0.9em;
    color: #666;
    margin-right: 4px;
    white-space: nowrap;
  }
  .handover-remove {
    border: none;
    background: transparent;
    font-size: 1.1em;
    cursor: pointer;
    color: #999;
  }
  .handover-remove:hover { color: #f33; }

  .handover-clear {
    margin-top: 4px;
    text-align: right;
  }
  .handover-clear button {
    border: none;
    background: #eee;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 0.9em;
    cursor: pointer;
  }

  /* ç«¯æœ«ãƒ©ãƒ™ãƒ« */
  .device-label-bar {
    margin-top: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    font-size: 12px;
  }
  .device-label-title { font-weight: 600; }
  .device-label-display {
    padding: 2px 8px;
    border-radius: 999px;
    background: #222;
    color: #fff;
    font-size: 11px;
  }
  .device-label-input {
    flex: 1;
    min-width: 140px;
    max-width: 220px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: 12px;
  }
  .device-label-save-btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: none;
    font-size: 12px;
    background: #1f7aec;
    color: #fff;
    cursor: pointer;
  }
  .device-label-save-btn:hover { opacity: 0.9; }

  /* ã‚·ãƒ•ãƒˆè¡¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å†…ï¼‰ */
  .shift-shortcut {
    margin-top: 8px;
    display: none;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    font-size: 11px;
  }
  .shift-btn {
    background: #fff;
    color: #111;
    border-radius: 999px;
    border: 1px solid #ddd;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
  }
  .shift-btn:hover { background: #f5f5f5; }
  .shift-btn:disabled { opacity: 0.5; cursor: default; }
  .shift-note { color: #ccc; font-size: 10px; }

  /* ä»Šã®æ™‚é–“å¸¯ã‚¸ãƒ£ãƒ³ãƒ—ãƒãƒŠãƒ¼ */
  .jump-banner {
    margin-top: 14px;
    margin-bottom: 12px;
    padding: 10px 14px;
    border-radius: 999px;
    background: #fff7e5;
    border: 1px solid #ffd48a;
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: flex-end;
  }
  .jump-banner-note {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    color: #c25a00;
    flex: 1;
  }
  .jump-banner-icon { font-size: 18px; line-height: 1; }
  .jump-btn {
    background: #111;
    color: #fff;
    padding: 8px 16px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1.2;
    box-shadow: 0 2px 4px rgba(0,0,0,0.16);
    transition: transform 0.08s ease, box-shadow 0.08s ease;
  }
  .jump-btn-main { font-weight: 600; }
  .jump-btn-sub {
    font-size: 10px;
    opacity: 0.9;
  }
  .jump-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.22);
  }
  .jump-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.18);
  }

  @media (max-width: 640px) {
    .jump-banner {
      flex-direction: column;
      align-items: flex-start;
      border-radius: 16px;
    }
    .jump-btn {
      width: 100%;
      align-items: center;
    }
    .sp-only { display: inline; }
  }
  .sp-only { display: none; }

  /* å¼•ãç¶™ããƒ¡ãƒ¢ï¼šãƒãƒƒãƒ—ï¼‹ã‚‚ã£ã¨è¡¨ç¤º */
  .handover-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
  }
  .handover-chips-primary,
  .handover-chips-extra {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .handover-chips-extra {
    width: 100%;
    margin-top: 4px;
  }
  .handover-chips-extra.is-hidden { display: none; }

  .handover-chip {
    border: 1px solid #ccc;
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 0.9em;
    background: #fafafa;
    cursor: pointer;
  }
  .handover-chip:hover { background: #eee; }

  .handover-chips-toggle {
    margin-left: auto;
    margin-top: 0;
    padding: 6px 14px;
    font-size: 12px;
    color: #a05a00;
    background: #fff7e5;
    border: 1px solid #ffc27a;
    border-radius: 20px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
  }
  .handover-chips-toggle:hover {
    background: #ffe9c6;
    box-shadow: 0 3px 6px rgba(0,0,0,0.12);
  }
  .handover-chips-toggle span.arrow {
    display: inline-block;
    transition: transform 0.25s ease;
  }
  .handover-chips-toggle.open {
    background: #ffe0b2;
    border-color: #ffb74d;
    color: #8d4b00;
  }
  .handover-chips-toggle.open span.arrow {
    transform: rotate(180deg);
  }

  /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  .app-menu-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .app-menu-title {
    font-size: 1em;
    font-weight: 600;
  }
  .app-menu-close {
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 1px solid #e0e0e0;
    background: #f7f7f7;
    color: #555;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    transition:
      background 0.15s ease,
      color 0.15s ease,
      border-color 0.15s ease,
      box-shadow 0.15s ease,
      transform 0.08s ease;
  }
  .app-menu-close:hover {
    background: #222;
    color: #fff;
    border-color: #222;
    box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    transform: translateY(-1px);
  }
  .app-menu-close:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.12);
  }
  .app-menu-section {
    margin-top: 10px;
  }
  .app-menu-section h3 {
    font-size: 0.95em;
    margin-bottom: 4px;
  }
  #scrollSpeedSelect {
    margin-top: 2px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ccc;
    font-size: 0.9em;
  }

  /* ==== DMMé¢¨ï¼šè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ ==== */
  .app-menu-body {
    margin-top: 4px;
  }

  .app-menu-list {
  list-style: none;
  margin: 0;
  padding: 0;
  border: none;             /* æ ç·šãªã— */
  background: transparent;  /* èƒŒæ™¯ã‚‚ã‚«ãƒ¼ãƒ‰ã£ã½ãã—ãªã„ */
  border-radius: 0;         /* è§’ä¸¸ã‚‚ãªã—ï¼ˆTwitterå¯„ã›ï¼‰ */
  overflow: visible;        /* ã¯ã¿å‡ºã—åˆ¶é™è§£é™¤ï¼ˆãŠå¥½ã¿ã§OKï¼‰ */
}


  .app-menu-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    border-bottom: 1px solid #f1f1f1;
  }

  .app-menu-item:last-child {
    border-bottom: none;
  }

  .app-menu-icon {
    width: 28px;
    font-size: 1.1em;
    text-align: center;
    margin-right: 10px;
  }

  .app-menu-main {
    flex: 1;
  }

  .app-menu-sub {
    font-size: 0.85em;
    color: #777;
  }

  .app-menu-right {
    margin-left: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .menu-link-btn {
    border: none;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 0.9em;
    background: #f5f5f5;
    cursor: pointer;
  }
  .menu-link-btn:hover {
    background: #eee;
  }

  .menu-arrow {
    font-size: 1.1em;
    color: #bbb;
  }

  .app-menu-font-buttons .btn-secondary {
    padding: 4px 8px;
    font-size: 0.9em;
  }

    /* === å·¦ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ === */
  .app-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.4);
    display: none;              /* JSã§ .open ã‚’ã¤ã‘ãŸã‚‰è¡¨ç¤º */
    justify-content: flex-start;/* å·¦å´ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å¯„ã›ã‚‹ */
    z-index: 7000;
  }

  .app-menu-overlay.open {
    display: flex;
  }

  /* å·¦ç«¯ã‹ã‚‰ãƒ‹ãƒ¥ãƒƒã¨å‡ºã¦ãã‚‹ã‚·ãƒ¼ãƒˆæœ¬ä½“ */
  .app-menu-sheet {
    width: 80%;
    max-width: 320px;
    height: 100vh;
    background: #fff;
    border-radius: 0;
    padding: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: 4px 0 12px rgba(0,0,0,0.25);
    animation: slideInFromLeft 0.2s ease-out;
  }

  /* æ¨ªå¹…ã‚ã‚‹ã¨ãã¯å›ºå®šå¹…ã« */
  @media (min-width: 768px) {
    .app-menu-sheet {
      width: 320px;
    }
  }

  /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸­èº«ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
  .app-menu-body {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 40px;
  }

  /* å·¦ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  @keyframes slideInFromLeft {
    from {
      transform: translateX(-20%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* ===== â‘  ãŠçŸ¥ã‚‰ã›æ—¢èª­ãƒãƒƒã‚¸ ï¼‹ ãƒœã‚¿ãƒ³ ===== */
  .notice-status-badge {
    display: inline-block;
    margin-left: 6px;
    padding: 1px 8px;
    border-radius: 999px;
    font-size: 10px;
    vertical-align: middle;
  }
  .notice-status-badge.unread {
    background: #f44336;
    color: #fff;
  }
  .notice-status-badge.read {
    background: #4caf50;
    color: #fff;
  }

  .notice-read-btn {
    margin-top: 6px;
    padding: 4px 10px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: #fafafa;
    cursor: pointer;
  }
  .notice-read-btn:hover {
    background: #f0f0f0;
  }

  /* ===== â‘¡ å„æ™‚é–“å¸¯ã®å®Œäº†ç‡ãƒãƒ¼ ===== */
  .slot-progress {
    margin-top: 4px;
    margin-bottom: 6px;
    padding: 6px 0;
    width: 100%;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }
  .slot-progress-label {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 4px;
  }
  .slot-progress-bar {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: #eee;
    overflow: hidden;
  }
  .slot-progress-bar-inner {
    height: 100%;
    width: 0%;
    border-radius: 999px;
    background: #1f7aec;
    transition: width 0.15s ease-out;
  }

  /* ===== ãŠçŸ¥ã‚‰ã›ã‚«ãƒ¼ãƒ‰ã ã‘ ç‰¹åˆ¥ãƒ‡ã‚¶ã‚¤ãƒ³ ===== */
  #notice-section {
    margin-top: 12px;
    border: 2px solid #ffb74d;
    background: #fffaf0;
    box-shadow: 0 3px 6px rgba(0,0,0,0.06);
    position: relative;
  }
  #notice-section::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff9800, #ffc107);
    border-radius: 10px 10px 0 0;
  }
  #notice-section .slot-header {
    align-items: center;
    margin-bottom: 6px;
  }
  #notice-section .slot-title {
    font-size: 1.25em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  #notice-section .slot-note {
    font-size: 0.9em;
    color: #b66a00;
    display: inline;        /* â† ã“ã‚Œè¿½åŠ ï¼ */
  }
  .notice-lead {
    font-size: 0.9em;
    color: #b66a00;
    background: #fff3cd;
    border-radius: 6px;
    padding: 4px 8px;
    margin-bottom: 6px;
  }
  #notice-section .info-list li {
    padding: 1px 0;
  }
  #notice-section .info-list li::before {
    content: "â—";
    font-size: 0.5em;
    color: #ff9800;
    margin-right: 6px;
  }
  #notice-section #notice-status-badge {
    margin-left: 8px;
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 10px;
  }
  #notice-section #notice-status-badge.unread {
    background: #e53935;
    color: #fff;
  }
  #notice-section #notice-status-badge.read {
    background: #43a047;
    color: #fff;
  }
  #notice-section .notice-read-btn {
    margin-top: 8px;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid #ffb74d;
    background: #fff;
    font-size: 0.9em;
    cursor: pointer;
    color: #b66a00;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
  }
  #notice-section .notice-read-btn:hover {
    background: #ffe8c2;
  }

.owner-news-summary {
  background: #fff;
  padding: 10px 12px;
  margin: 8px 8px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.04);
}

.owner-news-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
}

.owner-news-item {
  padding: 6px 0;
  border-top: 1px solid #eee;
}

.owner-news-item:first-of-type {
  border-top: none;
}

.owner-news-item-title {
  font-size: 13px;
  font-weight: 600;
}

.owner-news-item-body {
  font-size: 12px;
  color: #333;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis; /* 1è¡Œã§â€¦ã«ã™ã‚‹ */
}

.owner-news-item-meta {
  font-size: 11px;
  color: #777;
  margin-top: 1px;
}

.owner-news-empty {
  font-size: 12px;
  color: #777;
  margin: 4px 0;
}

.owner-news-more {
  margin-top: 8px;
  text-align: right;
  font-size: 12px;
}

.owner-news-more a {
  color: #111;
  text-decoration: underline;
}

/* ãŠçŸ¥ã‚‰ã›ã‚«ãƒ¼ãƒ‰å³ä¸‹ã®ã€ŒãŠçŸ¥ã‚‰ã›ã‚»ãƒ³ã‚¿ãƒ¼ã€ãƒªãƒ³ã‚¯ */
.notice-center-link {
  margin-top: 6px;
  text-align: right;
  font-size: 12px;
}
.notice-center-link a {
  color: #b66a00;
  text-decoration: underline;
}

.notice-bottom-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-top: 10px;
}

.notice-center-link {
  font-size: 13px;
  color: #b66a00;
  text-decoration: underline;
  cursor: pointer;
}

    /* ===== åˆæœŸèª­ã¿è¾¼ã¿ä¸­ã¯æœ¬ä½“ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒãƒ©ã¤ãé˜²æ­¢ ===== */
body.app-loading .app {
  opacity: 0;
  pointer-events: none;
}

body.app-ready .app {
  opacity: 1;
  transition: opacity 0.2s ease-out;
}











.badge-photo {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 999px;
  font-size: 10px;
  background: #ffe5e5;
  color: #b00;
  margin-left: 6px;
}


















/* ===== å†™çœŸã‚¿ã‚¹ã‚¯ UIï¼ˆç¾ã—ããƒ»SEæœ€é©åŒ–ï¼‰ ===== */

.task-photo-area {
  border: 1px solid #e5e5e5;
  background: #fafafa;
  padding: 8px 8px 4px;
  border-radius: 8px;
  margin: 6px auto 4px;   /* â† å·¦å³ auto ã§ä¸­å¤®å¯„ã› */
  display: flex;
  flex-direction: column;
  gap: 4px;
  max-width: 420px;        /* â† PC/iPad ã§ã¯å¹…420pxã§ã‚­ãƒ¬ã‚¤ã« */
  width: 100%;             /* â† ã‚¹ãƒãƒ›ã§ã¯ç”»é¢ã„ã£ã±ã„ä½¿ã† */
  box-sizing: border-box;
}

.task-photo-input {
  font-size: 12px;
  background: #fff;
  padding: 5px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
}

.task-photo-upload-btn {
  background: #4a8df7;
  color: #fff;
  padding: 6px 8px;
  font-size: 13px;
  border-radius: 6px;
  border: none;
  width: 100%;
  text-align: center;
}

.task-photo-upload-btn:active {
  background: #3a76d1;
}

.task-photo-status {
  font-size: 11px;
  color: #666;
  min-height: 0;    /* â† 14px â†’ 0 ã« */
  margin-top: 0;    /* â† å¿µã®ãŸã‚ */
}

/* === iPhone SE / ã‚¹ãƒãƒ›æœ€é©åŒ– === */
@media (max-width: 430px) {
  .task-photo-area {
    padding: 6px 6px 4px;
    gap: 4px;
  }

  .task-photo-input {
    font-size: 11px;
    padding: 4px;
  }

  .task-photo-upload-btn {
    font-size: 12px;
    padding: 5px 6px;
  }
}





















/* ä¸Šã®é»’ãƒ˜ãƒƒãƒ€ãƒ¼ã®å³ç«¯ã«å‡ºã™ãƒœã‚¿ãƒ³ */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.staff-logout-btn {
  margin-left: auto;
  padding: 6px 14px;
  border-radius: 999px;
  border: none;
  font-size: 12px;
  background: #ffffff;
  color: #333;
  cursor: pointer;
  white-space: nowrap;
}

.staff-logout-btn:hover {
  opacity: 0.9;
}




























  </style>
</head>
  
<body class="app-loading">

  <!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
  <div id="loginScreen">
    <div class="login-wrap">
      <div class="login-title">ã‚¹ã‚¿ãƒƒãƒ• ãƒ­ã‚°ã‚¤ãƒ³</div>
      <p class="login-subtitle">
        åº—èˆ—IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </p>
      <div class="login-field">
        <label for="loginStoreId">åº—èˆ—ID</label>
        <input id="loginStoreId" type="text" placeholder="ä¾‹ï¼šnambucho" autocomplete="off" />
      </div>
      <div class="login-field">
        <label for="loginStorePass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="loginStorePass" type="password" />
      </div>
      <div class="login-actions">
        <button id="loginBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <p class="login-note">
        â€»åŒã˜ç«¯æœ«ãƒ»åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã€ç´„15æ™‚é–“ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¶šãã¾ã™ã€‚
      </p>
    </div>
  </div>

  <!-- ===== æœ¬ä½“ç”»é¢ ===== -->
  <div class="app">
    <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
    <header class="top-bar">
  <div class="app-header">
    <button type="button" class="app-menu-btn" id="appMenuBtn" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
      <span class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </button>
    <h1>æ¥­å‹™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h1>

 <button id="staffLogoutBtn" class="staff-logout-btn" type="button">
      åº—èˆ—åˆ‡ã‚Šæ›¿ãˆ / ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    </button>



  </div>
  <p>æ™‚é–“å¸¯ã”ã¨ã® Aï¼å¿…é ˆ / Bï¼ä½™è£•ã‚ã‚Œã°ã€‚è¿·ã£ãŸã‚‰Aã‹ã‚‰ã€‚</p>

      <!-- ç«¯æœ«ãƒ©ãƒ™ãƒ« -->
      <div class="device-label-bar">
        <span class="device-label-title">åå‰ã‚’å…¥åŠ›ï¼š</span>
        <span id="deviceLabelDisplay" class="device-label-display">æœªè¨­å®š</span>
        <input
          id="deviceLabelInput"
          class="device-label-input"
          type="text"
          placeholder="ä¾‹ï¼šãŸãªã‹"
        />
        <button id="deviceLabelSaveBtn" class="device-label-save-btn">
          ä¿å­˜
        </button>
      </div>

      <!-- ã‚·ãƒ•ãƒˆè¡¨ãƒ¯ãƒ³ã‚¿ãƒƒãƒ— -->
      <div class="shift-shortcut">
        <button type="button" id="openShiftBtn" class="shift-btn">
          <span>ğŸ“… ã‚·ãƒ•ãƒˆè¡¨</span>
        </button>
        <span class="shift-note">
          â€»ã€Œä»Šé€±ã®ã‚·ãƒ•ãƒˆè¡¨ç”»åƒã€ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ãã¾ã™ã€‚
        </span>
      </div>

      <!-- æ™‚é–“å¸¯ãƒŠãƒ“ -->
      <nav class="nav">
        <!-- JSã§ timeSlots è¨­å®šã‹ã‚‰ä¸Šæ›¸ãç”Ÿæˆã™ã‚‹ -->
        <a href="#t6-8">6ã€œ8æ™‚</a>
        <a href="#t9-11">9ã€œ11æ™‚</a>
        <a href="#t12-14">12ã€œ14æ™‚</a>
        <a href="#t15-17">15ã€œ17æ™‚</a>
        <a href="#t18-20">18ã€œ20æ™‚</a>
        <a href="#t21-23">21ã€œ23æ™‚</a>
        <a href="#t0-2">0ã€œ2æ™‚</a>
        <a href="#t3-5">3ã€œ5æ™‚</a>
      </nav>

      <!-- æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰ -->
      <div class="font-size-selector">
        <button data-size="small">å°</button>
        <button data-size="medium">ä¸­</button>
        <button data-size="large">å¤§</button>
      </div>



    </header>

    <main>
      <!-- ç¾åœ¨æ™‚åˆ»è¡¨ç¤º -->
      <div id="time-display" style="padding: 10px; color: #333;">
        æ™‚åˆ»ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
      </div>

      <!-- ä»Šã®æ™‚é–“å¸¯ã¸ã‚¸ãƒ£ãƒ³ãƒ— -->
      <div class="jump-banner">
        <div class="jump-banner-note">
          <span class="jump-banner-icon">â°</span>
          <span class="jump-banner-text">
            â€»ãŠçŸ¥ã‚‰ã›ã‚’èª­ã‚“ã ã‚‰ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<br class="sp-only">
            ã€Œä»Šã‚„ã‚‹æ™‚é–“å¸¯ã€ã®æ¬„ã¾ã§ç§»å‹•ã—ã¦ãã ã•ã„ã€‚
          </span>
        </div>
        <button id="jumpNowSlotBtn" class="jump-btn">
          <span class="jump-btn-main">ä»Šã®æ™‚é–“å¸¯ã¸</span>
          <span class="jump-btn-sub">ã‚¿ã‚¹ã‚¯æ¬„ã¾ã§ã‚¸ãƒ£ãƒ³ãƒ—</span>
        </button>
      </div>

      <!-- ãŠçŸ¥ã‚‰ã› -->
      <section class="slot" id="notice-section">
        <div class="slot-header">
          <div class="slot-title">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</div>
          <div class="slot-note">
            çµŒå–¶è€…ã‹ã‚‰ã®å…±æœ‰äº‹é …
            <span id="notice-status-badge" class="notice-status-badge"></span>
          </div>
        </div>
        <p class="notice-lead">
          â€»ã‚·ãƒ•ãƒˆå¤‰æ›´ã‚„é‡è¦ãªé€£çµ¡ã¯ã€å¿…ãšã“ã“ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="tasks-group">
          <h3><span class="badge badge-a">ãŠçŸ¥ã‚‰ã›</span></h3>
          <ul class="info-list" id="notice-list">
            <li>ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
          </ul>
          <div class="notice-bottom-row">
            <button id="notice-read-btn" class="notice-read-btn">
              ã™ã¹ã¦èª­ã‚“ã ã“ã¨ã«ã™ã‚‹
            </button>

            <a
  href="#"
  id="openNoticeCenterBtn"
  class="notice-center-link"
>
  â–¶ ãŠçŸ¥ã‚‰ã›ã‚»ãƒ³ã‚¿ãƒ¼ã‚’è¦‹ã‚‹
</a>
          </div>
        </div>
      </section>

      <!-- å…±é€š å¼•ãç¶™ããƒ¡ãƒ¢ -->
      <section class="slot handover-slot" data-slot="global">
        <div class="slot-header">
          <div class="slot-title">å¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆå…¨å“¡ã§å…±æœ‰ãƒ»å…¨æ™‚é–“å¸¯å…±é€šï¼‰</div>
          <div class="slot-note">æ™‚é–“å¸¯ã‚’ã¾ãŸãæ™‚ã®å…±æœ‰ãƒ¡ãƒ¢</div>
        </div>
        <div class="handover">
          <p class="handover-note">
            æ–‡ç« ã‚’æ›¸ãã®ãŒã ã‚‹ã„äººå‘ã‘ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒ¡ãƒ¢ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚<br>
            â€»å³å´ã«ã€Œæ™‚é–“ / åå‰ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </p>
          <div class="handover-chips"></div>
          <ul class="handover-log"></ul>
          <div class="handover-clear">
            <button type="button" class="handover-clear-btn">ãƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã™</button>
          </div>
        </div>
      </section>

      <!-- ===== ä»¥ä¸‹ã€æ™‚é–“å¸¯ã”ã¨ã®ã‚¿ã‚¹ã‚¯ï¼ˆæœ€åˆã®8æšã¯ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰ ===== -->

      <!-- 6ã€œ8æ™‚ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬1æšç›®ï¼‰ -->
      <section id="t6-8" class="slot">
        <div class="slot-header">
          <div class="slot-title">6:00ã€œ8:00</div>
          <div class="slot-note">æœã®ç«‹ã¡ä¸Šã’</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a">
            <!-- Firestoreã®å®šç¾©ã§ä¸Šæ›¸ãã•ã‚Œã‚‹ -->
          </ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b">
          </ul>
        </div>
      </section>

      <!-- 9ã€œ11æ™‚ -->
      <section id="t9-11" class="slot">
        <div class="slot-header">
          <div class="slot-title">9:00ã€œ11:00</div>
          <div class="slot-note">åˆå‰å¸¯</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 12ã€œ14æ™‚ -->
      <section id="t12-14" class="slot">
        <div class="slot-header">
          <div class="slot-title">12:00ã€œ14:00</div>
          <div class="slot-note">æ˜¼å¸¯</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 15ã€œ17æ™‚ -->
      <section id="t15-17" class="slot">
        <div class="slot-header">
          <div class="slot-title">15:00ã€œ17:00</div>
          <div class="slot-note">å¤•æ–¹å‰</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 18ã€œ20æ™‚ -->
      <section id="t18-20" class="slot">
        <div class="slot-header">
          <div class="slot-title">18:00ã€œ20:00</div>
          <div class="slot-note">å¤•æ–¹ã€œå¤œ</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 21ã€œ23æ™‚ -->
      <section id="t21-23" class="slot">
        <div class="slot-header">
          <div class="slot-title">21:00ã€œ23:00</div>
          <div class="slot-note">å¤œå¸¯</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 0ã€œ2æ™‚ -->
      <section id="t0-2" class="slot">
        <div class="slot-header">
          <div class="slot-title">0:00ã€œ2:00</div>
          <div class="slot-note">æ·±å¤œå‰åŠ</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- 3ã€œ5æ™‚ -->
      <section id="t3-5" class="slot">
        <div class="slot-header">
          <div class="slot-title">3:00ã€œ5:00</div>
          <div class="slot-note">æ—©æœ</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">A å¿…é ˆ</span> ã“ã®æ™‚é–“ã«å¿…ãšã‚„ã‚‹ã“ã¨</h3>
          <ul class="tasks a"></ul>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-b">B ä½™è£•</span> æ™‚é–“ãŒä½™ã£ãŸã¨ãã«ã§ããŸã‚‰åŠ©ã‹ã‚‹ã“ã¨</h3>
          <ul class="tasks b"></ul>
        </div>
      </section>

      <!-- ================== ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ ================== -->
      <div class="app-menu-overlay" id="appMenuOverlay">
        <div class="app-menu-sheet">
          <div class="app-menu-header">
            <div class="app-menu-title">è¡¨ç¤ºãƒ»ã‚·ãƒ•ãƒˆè¨­å®š</div>
            <button type="button" class="app-menu-close" id="appMenuClose">âœ•</button>
          </div>

          <div class="app-menu-body">
            <ul class="app-menu-list">
              <li class="app-menu-item">
                <div class="app-menu-icon">ğŸ“…</div>
                <div class="app-menu-main">
                  <div class="app-menu-title">ã‚·ãƒ•ãƒˆè¡¨</div>
                  <div class="app-menu-sub">ä»Šé€±ã®ã‚·ãƒ•ãƒˆç”»åƒã‚’é–‹ã</div>
                </div>
                <div class="app-menu-right app-menu-font-buttons">
                  <button type="button" id="openShiftFromMenu" class="menu-link-btn">
                    é–‹ã
                  </button>
                  <span class="menu-arrow">â€º</span>
                </div>
              </li>

              <li class="app-menu-item">
                <div class="app-menu-icon">ğŸ”¤</div>
                <div class="app-menu-main">
                  <div class="app-menu-title">æ–‡å­—ã®å¤§ãã•</div>
                  <div class="app-menu-sub">è¦‹ã‚„ã™ã„ã‚µã‚¤ã‚ºã‚’é¸ã‚“ã§ãã ã•ã„</div>
                </div>
                <div class="app-menu-right app-menu-font-buttons">
                  <button type="button" data-size="small" class="btn-secondary">å°</button>
                  <button type="button" data-size="medium" class="btn-secondary">ä¸­</button>
                  <button type="button" data-size="large" class="btn-secondary">å¤§</button>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

    </main>

    <div class="footer-note">
      è¿·ã£ãŸã‚‰ï¼šAã‚¿ã‚¹ã‚¯ â†’ å‰é™³ â†’ æ¸…æƒ ã®é †ã§å‹•ã‘ã°OKã€‚
    </div>
  </div>

    <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>


  <script>
    // =============================
    // Firebase è¨­å®š
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();  // â˜… è¿½åŠ 

    // ===== ãŠçŸ¥ã‚‰ã›ï¼ˆæ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ =====
    function formatDateForSummary(ts) {
      if (!ts) return "";
      const d = ts.toDate();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${mm}/${dd} ${hh}:${mi}`;
    }

    const ownerNewsSummaryList = document.getElementById("ownerNewsSummaryList");
    const ownerNewsSummaryEmpty = document.getElementById("ownerNewsSummaryEmpty");

    // ownerNews ã®ã€Œæœ€æ–°3ä»¶ã ã‘ã€ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ï¼ˆè¦ç´ ãŒã‚ã‚‹ã¨ãã ã‘ï¼‰
    if (ownerNewsSummaryList && ownerNewsSummaryEmpty) {
      db.collection("ownerNews")
        .orderBy("createdAt", "desc")
        .limit(3)
        .onSnapshot((snap) => {
          ownerNewsSummaryList.innerHTML = "";

          if (snap.empty) {
            ownerNewsSummaryEmpty.style.display = "block";
            return;
          }
          ownerNewsSummaryEmpty.style.display = "none";

          snap.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "owner-news-item";

            const title = data.title || "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)";
            const body = (data.body || "").replace(/\n/g, "ã€€");
            const author = data.author || "ã‚ªãƒ¼ãƒŠãƒ¼";
            const date = formatDateForSummary(data.createdAt);

            div.innerHTML = `
              <div class="owner-news-item-title">ãƒ»${title}</div>
              <div class="owner-news-item-body">${body}</div>
              <div class="owner-news-item-meta">${author} ï¼ ${date}</div>
            `;
            ownerNewsSummaryList.appendChild(div);
          });
        });
    }

        // â˜… åº—èˆ—ã”ã¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆFirestoreæœªè¨­å®šã®ã¨ãã®ä¿é™ºç”¨ï¼‰
    const STORE_PASSWORDS = {
      nambucho: "1",
      // 2åº—èˆ—ç›®ä»¥é™ã¯ã“ã“ã«è¿½åŠ 
      // oosakanamba: "osaka777",
    };

    // â˜… åº—èˆ—IDï¼š?store=xxx ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°ç©ºæ¬„
function resolveStoreId() {
  const params = new URLSearchParams(location.search);
  const fromUrl = params.get("store");

  if (fromUrl && fromUrl.trim()) {
    return fromUrl.trim();   // URL ã§æŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿è‡ªå‹•å…¥åŠ›
  }
  return "";                 // â† ãã‚Œä»¥å¤–ã¯ç©ºæ¬„
}


    // ï¼ˆå¿…è¦ãªã‚‰ï¼‰äº‹å‰ã«è¨±å¯ã—ã¦ãŠãåº—èˆ—ä¸€è¦§
    // ä»Šã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å®šç¾©ç”¨ã¨ã—ã¦ã ã‘ä½¿ã†ã‚¤ãƒ¡ãƒ¼ã‚¸
    const ALLOWED_STORES = Object.keys(STORE_PASSWORDS);

    // â˜… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const STORE_ID_CACHE_KEY = "cachedStoreId";
    const STORE_ID_TIME_KEY = "cachedStoreId_time";
    const STORE_PASS_CACHE_PREFIX = "storePass_";
    const LOGIN_LIMIT_MS = 15 * 60 * 60 * 1000; // 15æ™‚é–“

    // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹åº—èˆ—IDã¨Firestoreå‚ç…§
    let STORE_ID = null;
    let storeRef = null;

    function saveLoginCache(storeId) {
      const now = Date.now();
      localStorage.setItem(STORE_ID_CACHE_KEY, storeId);
      localStorage.setItem(STORE_ID_TIME_KEY, String(now));
      localStorage.setItem(STORE_PASS_CACHE_PREFIX + storeId, String(now));
    }

    function getCachedLoginStoreId() {
      const now = Date.now();
      const storeId = localStorage.getItem(STORE_ID_CACHE_KEY);

      // â˜… ALLOWED_STORES ãƒã‚§ãƒƒã‚¯ã¯å¤–ã™ï¼ˆ?store=xxx ã¿ãŸã„ãªå°†æ¥ã®åº—èˆ—ã‚‚é€šã™ãŸã‚ï¼‰
      if (!storeId) return null;

      const tId = Number(localStorage.getItem(STORE_ID_TIME_KEY));
      const tPass = Number(localStorage.getItem(STORE_PASS_CACHE_PREFIX + storeId));
      if (!tId || !tPass) return null;
      if (now - tId > LOGIN_LIMIT_MS || now - tPass > LOGIN_LIMIT_MS) return null;

      return storeId;
    }


    // =============================
    // å–¶æ¥­æ—¥ã‚­ãƒ¼è¨ˆç®—ï¼ˆ7:00åˆ‡ã‚Šæ›¿ãˆï¼‰
    // =============================
    function getCurrentBusinessKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = now.getDate();
      const base = new Date(y, m, d);

      if (now.getHours() < 7) {
        base.setDate(base.getDate() - 1);
      }

      const yy = base.getFullYear();
      const mm = String(base.getMonth() + 1).padStart(2, "0");
      const dd = String(base.getDate()).padStart(2, "0");
      return `${yy}-${mm}-${dd}`;
    }

    // =============================
    // 7:00 è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
    // =============================
    function setupDailyResetAt7AM() {
      function scheduleNextReset() {
        const now = new Date();
        const next = new Date();
        next.setHours(7, 0, 0, 0);
        if (now >= next) {
          next.setDate(next.getDate() + 1);
        }
        const ms = next - now;
        setTimeout(() => {
          location.reload();
          scheduleNextReset();
        }, ms);
      }
      scheduleNextReset();
    }

    // =============================
    // æ™‚é–“å¸¯ID åˆ¤å®šï¼ˆowner.html ã® timeSlots ã«ã‚‚å¯¾å¿œï¼‰
    // =============================
    let dynamicTimeSlots = null; // [{id,label,fromHour,toHour,note}, â€¦]

    function setDynamicTimeSlots(configs) {
      dynamicTimeSlots = Array.isArray(configs) && configs.length ? configs : null;
    }

    function getCurrentSlotIdByHour(hour) {
      const h = ((hour % 24) + 24) % 24;

      // â˜… ã‚«ã‚¹ã‚¿ãƒ  timeSlots ãŒã‚ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã‚’å„ªå…ˆ
      if (dynamicTimeSlots && dynamicTimeSlots.length) {
        for (const s of dynamicTimeSlots) {
          const from = Number(
            s.fromHour ?? s.startHour ?? s.from ?? s.start ?? 0
          );
          const to = Number(
            s.toHour ?? s.endHour ?? s.to ?? s.end ?? 0
          );
          if (Number.isNaN(from) || Number.isNaN(to)) continue;

          if (from === to) continue; // ç„¡åŠ¹

          if (from < to) {
            // é€šå¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆä¾‹ï¼š9ã€œ12ï¼‰
            if (h >= from && h < to) return s.id;
          } else {
            // 0æ™‚ã¾ãŸãï¼ˆä¾‹ï¼š21ã€œ3ï¼‰
            if (h >= from || h < to) return s.id;
          }
        }
        // ã©ã‚Œã«ã‚‚å½“ã¦ã¯ã¾ã‚‰ãªã‘ã‚Œã°å…ˆé ­ã‚’è¿”ã™
        return dynamicTimeSlots[0]?.id || "t6-8";
      }

      // â˜… ã‚«ã‚¹ã‚¿ãƒ ãªã— â†’ æ—§å›ºå®šãƒ­ã‚¸ãƒƒã‚¯
      if (h >= 6 && h < 9)  return "t6-8";
      if (h >= 9 && h < 12) return "t9-11";
      if (h >= 12 && h < 15) return "t12-14";
      if (h >= 15 && h < 18) return "t15-17";
      if (h >= 18 && h < 21) return "t18-20";
      if (h >= 21 && h < 24) return "t21-23";
      if (h >= 0 && h < 3)   return "t0-2";
      return "t3-5";
    }

    function scrollToCurrentTimeSlot() {
      const now = new Date();
      const h = now.getHours();
      const slotId = getCurrentSlotIdByHour(h);
      const el = document.getElementById(slotId);
      if (!el) return;

      setTimeout(() => {
        const header = document.querySelector(".top-bar") || document.querySelector("header");
        const headerHeight = header ? header.offsetHeight : 80;
        const rect = el.getBoundingClientRect();
        const targetY = rect.top + window.scrollY - headerHeight - 10;
        window.scrollTo({
          top: targetY,
          behavior: "smooth"
        });
      }, 400);
    }


    document.addEventListener("DOMContentLoaded", () => {
  const loginScreen = document.getElementById("loginScreen");
  const appEl = document.querySelector(".app");
  const loginStoreIdInput = document.getElementById("loginStoreId");
  const loginStorePassInput = document.getElementById("loginStorePass");
  const loginBtn = document.getElementById("loginBtn");

  // â˜… åº—èˆ—IDã¯ã€Œå…¥åŠ›ã§ãã‚‹ã€ã‚ˆã†ã«ã™ã‚‹ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°åˆæœŸå€¤ã«ã™ã‚‹ï¼‰
if (loginStoreIdInput) {
  const initialId = resolveStoreId();   // ?store=xxx ãŒã‚ã‚Œã°ãã‚Œã€ãªã‘ã‚Œã°ç©ºæ¬„
  if (initialId) {
    loginStoreIdInput.value = initialId;  // ã‚ã‚‹å ´åˆã®ã¿åˆæœŸã‚»ãƒƒãƒˆ
  }
  // ğŸ‘‡éè¡¨ç¤ºã«ã¯ã—ãªã„ï¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã§ãã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
}



      // â˜… å¿µã®ãŸã‚ã€èª­ã¿è¾¼ã¿ä¸­ã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã¦ãŠã
      document.body.classList.add("app-loading");

      // â˜… ã‚¢ãƒ—ãƒªæº–å‚™å®Œäº†æ™‚ã«å‘¼ã¶
      function setAppReady() {
        document.body.classList.remove("app-loading");
        document.body.classList.add("app-ready");
      }

      function showLogin() {
        if (loginScreen) loginScreen.style.display = "flex";
        if (appEl) appEl.style.display = "none";
      }
      function showApp() {
        if (loginScreen) loginScreen.style.display = "none";
        if (appEl) appEl.style.display = "block";
      }

      // =============================
      // æœ¬ä½“åˆæœŸåŒ–ï¼ˆSTORE_ID / storeRef ãŒã‚»ãƒƒãƒˆæ¸ˆã¿ã§å‘¼ã¶ï¼‰
      // =============================
      function startApp() {
ã€€ã€€ã€€ã€€// â˜… storeRef ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„ï¼ˆå®‰å…¨ã‚¬ãƒ¼ãƒ‰ï¼‰
        if (!STORE_ID || !storeRef) {
          console.warn("STORE_ID / storeRef æœªè¨­å®šã®ãŸã‚ã€startApp ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚");
          showLogin();
          setAppReady();
          return;
        }

        
        // åº—èˆ—ID / ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆâ€» index.html ã«ã¯éè¡¨ç¤ºã ã‘ã©ä¸€å¿œï¼‰
        const storeIdDisplay = document.getElementById("storeIdDisplay");
        const storePassDisplay = document.getElementById("storePassDisplay");

        if (storeIdDisplay) {
          storeIdDisplay.textContent = STORE_ID || "æœªè¨­å®š";
        }

        if (storePassDisplay) {
          const pass = STORE_PASSWORDS[STORE_ID];
          if (pass) {
            storePassDisplay.value = pass;
          } else {
            storePassDisplay.value = "";
            storePassDisplay.placeholder = "æœªè¨­å®š";
          }
        }

        // â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚’è¡¨ç¤ºï¼ˆCSSã§ã¯ display: none ãªã®ã§ JSã§ONï¼‰
        // â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã¯ä½¿ã‚ãªã„ã®ã§è¡¨ç¤ºã—ãªã„
// const navElForDisplay = document.querySelector(".nav");
// if (navElForDisplay) {
//   navElForDisplay.style.display = "flex";
// }


        // ===== DMMé¢¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ =====
        const appMenuBtn = document.getElementById("appMenuBtn");
        const appMenuOverlay = document.getElementById("appMenuOverlay");
        const appMenuClose = document.getElementById("appMenuClose");

        function openAppMenu() {
          if (appMenuOverlay) appMenuOverlay.style.display = "flex";
        }
        function closeAppMenu() {
          if (appMenuOverlay) appMenuOverlay.style.display = "none";
        }

        appMenuBtn?.addEventListener("click", openAppMenu);
        appMenuClose?.addEventListener("click", closeAppMenu);
        appMenuOverlay?.addEventListener("click", (e) => {
          if (e.target === appMenuOverlay) {
            closeAppMenu();
          }
        });



      


      // =============================
        // ãŠçŸ¥ã‚‰ã›ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ç”¨ï¼‰ã¸ã®ãƒªãƒ³ã‚¯
        // =============================
        const openNoticeBtn = document.getElementById("openNoticeCenterBtn");
        if (openNoticeBtn && STORE_ID) {
          const noticeUrl = `notice.html?store=${encodeURIComponent(STORE_ID)}`;

          // aã‚¿ã‚°ãªã‚‰ href ã«ã‚»ãƒƒãƒˆ
          if (openNoticeBtn.tagName === "A") {
            openNoticeBtn.href = noticeUrl;
            openNoticeBtn.target = "_blank";
          } else {
            // button ãªã©ã®å ´åˆã¯ click ã§é–‹ã
            openNoticeBtn.addEventListener("click", () => {
              window.open(noticeUrl, "_blank");
            });
          }
        }







        // =============================
        // ã‚·ãƒ•ãƒˆè¡¨URLèª­ã¿è¾¼ã¿
        // =============================
        const openShiftBtn = document.getElementById("openShiftBtn");
        const openShiftFromMenu = document.getElementById("openShiftFromMenu");
        let shiftImageUrl = null;

        function loadShiftImageUrl() {
          storeRef.collection("settings").doc("shiftSheet").get()
            .then((snap) => {
              if (!snap.exists) {
                [openShiftBtn, openShiftFromMenu].forEach((btn) => {
                  if (btn) {
                    btn.textContent = "ã‚·ãƒ•ãƒˆè¡¨ï¼ˆæœªè¨­å®šï¼‰";
                    btn.disabled = true;
                  }
                });
                return;
              }
              const data = snap.data() || {};
              shiftImageUrl = data.imageUrl || null;

              if (!shiftImageUrl) {
                [openShiftBtn, openShiftFromMenu].forEach((btn) => {
                  if (btn) {
                    btn.textContent = "ã‚·ãƒ•ãƒˆè¡¨ï¼ˆæœªè¨­å®šï¼‰";
                    btn.disabled = true;
                  }
                });
              }
            })
            .catch((err) => {
              console.error("shiftSheet èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", err);
              [openShiftBtn, openShiftFromMenu].forEach((btn) => {
                if (btn) {
                  btn.textContent = "ã‚·ãƒ•ãƒˆè¡¨èª­ã¿è¾¼ã¿å¤±æ•—";
                  btn.disabled = true;
                }
              });
            });
        }

        function openShiftWindow() {
          if (shiftImageUrl) {
            window.open(shiftImageUrl, "_blank");
          } else {
            alert("ã¾ã ã‚·ãƒ•ãƒˆè¡¨ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nã‚ªãƒ¼ãƒŠãƒ¼ç”»é¢ã‹ã‚‰URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
          }
        }

        if (openShiftBtn) openShiftBtn.addEventListener("click", openShiftWindow);
        if (openShiftFromMenu) openShiftFromMenu.addEventListener("click", openShiftWindow);
        loadShiftImageUrl();

        // ä»Šã®æ™‚é–“å¸¯ã¸
        const jumpBtn = document.getElementById("jumpNowSlotBtn");
        if (jumpBtn) {
          jumpBtn.addEventListener("click", scrollToCurrentTimeSlot);
        }

        // ç«¯æœ«ãƒ©ãƒ™ãƒ«
        const DEVICE_LABEL_KEY = "nb_lawson_device_label";
        const deviceLabelDisplay = document.getElementById("deviceLabelDisplay");
        const deviceLabelInput   = document.getElementById("deviceLabelInput");
        const deviceLabelSaveBtn = document.getElementById("deviceLabelSaveBtn");
        let currentDeviceLabel = "æœªè¨­å®š";

        function loadDeviceLabel() {
          const saved = localStorage.getItem(DEVICE_LABEL_KEY);
          if (saved && saved.trim() !== "") {
            currentDeviceLabel = saved.trim();
            if (deviceLabelDisplay) deviceLabelDisplay.textContent = currentDeviceLabel;
            if (deviceLabelInput)   deviceLabelInput.value = currentDeviceLabel;
          } else {
            currentDeviceLabel = "æœªè¨­å®š";
            if (deviceLabelDisplay) deviceLabelDisplay.textContent = "æœªè¨­å®š";
          }
        }

        function saveDeviceLabel() {
          if (!deviceLabelInput) return;
          const value = deviceLabelInput.value.trim();
          if (!value) {
            alert("ç«¯æœ«ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãƒ¬ã‚¸æ¨ªiPadï¼‰");
            return;
          }
          currentDeviceLabel = value;
          localStorage.setItem(DEVICE_LABEL_KEY, value);
          if (deviceLabelDisplay) deviceLabelDisplay.textContent = value;
        }

        deviceLabelSaveBtn?.addEventListener("click", saveDeviceLabel);
        deviceLabelInput?.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            saveDeviceLabel();
          }
        });

        loadDeviceLabel();

        // æ–‡å­—ã‚µã‚¤ã‚º
        const sizeButtons = document.querySelectorAll("button[data-size]");
        function applyFontSize(size) {
          document.body.classList.remove("font-medium", "font-large");
          if (size === "medium") document.body.classList.add("font-medium");
          if (size === "large")  document.body.classList.add("font-large");

          sizeButtons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.size === size);
          });

          localStorage.setItem("fontSizeSetting", size);
        }

        sizeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const size = btn.dataset.size || "small";
            applyFontSize(size);
          });
        });

        const savedSize = localStorage.getItem("fontSizeSetting") || "small";
        applyFontSize(savedSize);

        // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
        const timeDisplay = document.getElementById("time-display");

        function updateTimeDisplay() {
          if (!timeDisplay) return;
          const now = new Date();
          const jp = now.toLocaleString("ja-JP", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            weekday: "short",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });

          const businessKey = getCurrentBusinessKey();

          let nextReset = new Date();
          nextReset.setHours(7, 0, 0, 0);
          if (now >= nextReset) {
            nextReset.setDate(nextReset.getDate() + 1);
          }
          const nextResetStr = nextReset.toLocaleString("ja-JP", {
            month: "2-digit",
            day: "2-digit",
            weekday: "short",
            hour: "2-digit",
            minute: "2-digit"
          });

          timeDisplay.innerHTML = `
            <div><strong>ç¾åœ¨æ™‚åˆ»ï¼š</strong> ${jp}</div>
            <div><strong>ä»Šæ—¥ã®å–¶æ¥­æ—¥ï¼š</strong> ${businessKey}ï¼ˆ7:00åˆ‡æ›¿ï¼‰</div>
            <div><strong>æ¬¡ã®ãƒªã‚»ãƒƒãƒˆï¼š</strong> ${nextResetStr}</div>
          `;
        }

        updateTimeDisplay();
        setInterval(updateTimeDisplay, 1000);

        // =============================
        // timeSlots ã®å®šç¾©ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ + Firestoreï¼‰
        // =============================
        // index.html ã«æœ€åˆã‹ã‚‰ã‚ã‚‹8å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€Œé †ç•ªã€ã§ä¿æŒã—ã¦ãŠã
        const originalSlotIdsInDom = ["t6-8","t9-11","t12-14","t15-17","t18-20","t21-23","t0-2","t3-5"];
        const initialSlotSectionEls = originalSlotIdsInDom
          .map((id) => document.getElementById(id))
          .filter(Boolean);

        // å®Ÿéš›ã«ä½¿ã†ã‚»ã‚¯ã‚·ãƒ§ãƒ³é…åˆ—ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã™ï¼‰
        let timeSlotSectionEls = [...initialSlotSectionEls];

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆ1æšç›®ï¼‰ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ç”¨ã«ä¿æŒ
        const slotTemplate = initialSlotSectionEls[0]
          ? initialSlotSectionEls[0].cloneNode(true)
          : null;

        if (slotTemplate) {
          // id ã¯å¾Œã‹ã‚‰ä»˜ã‘ç›´ã™ã®ã§ä¸€æ—¦å¤–ã™
          slotTemplate.removeAttribute("id");
          slotTemplate.dataset.slotId = "";

          const titleEl = slotTemplate.querySelector(".slot-title");
          const noteEl  = slotTemplate.querySelector(".slot-note");
          if (titleEl) titleEl.textContent = "";
          if (noteEl)  noteEl.textContent  = "";

          // ã‚¿ã‚¹ã‚¯ã¯ Firestore ã‹ã‚‰å…¥ã‚Œã‚‹ã®ã§ãƒ†ãƒ³ãƒ—ãƒ¬ã¯ç©ºã«ã—ã¦ãŠã
          slotTemplate.querySelectorAll("ul.tasks").forEach((ul) => {
            ul.innerHTML = "";
          });

          // å¿µã®ãŸã‚é€²æ—ãƒãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
          const prog = slotTemplate.querySelector(".slot-progress");
          if (prog) prog.remove();
        }

        // å¿…è¦ãªæ•°ã ã‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¢—ã‚„ã™ï¼ˆ24å€‹ã¾ã§OKï¼‰
        function ensureSlotSectionCount(count) {
          if (!slotTemplate) return;
          if (timeSlotSectionEls.length >= count) return;

          // æ—¢å­˜ã‚¹ãƒ­ãƒƒãƒˆã®ã„ã¡ã°ã‚“æœ€å¾Œã¨åŒã˜è¦ªã«è¿½åŠ ã™ã‚‹
          const last = timeSlotSectionEls[timeSlotSectionEls.length - 1];
          const container = last ? last.parentElement : null;
          if (!container) return;

          while (timeSlotSectionEls.length < count) {
            const newSection = slotTemplate.cloneNode(true);
            container.appendChild(newSection);
            timeSlotSectionEls.push(newSection);
          }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ™‚é–“å¸¯å®šç¾©ï¼ˆowner.html å´ã¨åŒã˜IDã«ã—ã¦ãŠãï¼‰
        let timeSlotConfigs = [
          { id: "t6-8",  label: "6:00ã€œ8:00",  note: "æœã®ç«‹ã¡ä¸Šã’", fromHour: 6,  toHour: 8  },
          { id: "t9-11", label: "9:00ã€œ11:00", note: "åˆå‰å¸¯",       fromHour: 9,  toHour: 11 },
          { id: "t12-14",label: "12:00ã€œ14:00",note: "æ˜¼å¸¯",         fromHour: 12, toHour: 14 },
          { id: "t15-17",label: "15:00ã€œ17:00",note: "å¤•æ–¹å‰",       fromHour: 15, toHour: 17 },
          { id: "t18-20",label: "18:00ã€œ20:00",note: "å¤•æ–¹ã€œå¤œ",     fromHour: 18, toHour: 20 },
          { id: "t21-23",label: "21:00ã€œ23:00",note: "å¤œå¸¯",         fromHour: 21, toHour: 23 },
          { id: "t0-2",  label: "0:00ã€œ2:00",  note: "æ·±å¤œå‰åŠ",     fromHour: 0,  toHour: 2  },
          { id: "t3-5",  label: "3:00ã€œ5:00",  note: "æ—©æœ",         fromHour: 3,  toHour: 5  }
        ];

        let timeSlotIds = timeSlotConfigs.map((s) => s.id);

        // DOMã« timeSlotConfigs ã‚’åæ˜ ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ID / navï¼‰
        function applyTimeSlotsToUI() {
          // ã‚»ã‚¯ã‚·ãƒ§ãƒ³å´
          timeSlotSectionEls.forEach((sectionEl, index) => {
            const cfg = timeSlotConfigs[index];
            if (!cfg) {
              sectionEl.style.display = "none";
              return;
            }
            sectionEl.style.display = "";
            sectionEl.id = cfg.id;
            sectionEl.dataset.slotId = cfg.id;

            const titleEl = sectionEl.querySelector(".slot-title");
            const noteEl  = sectionEl.querySelector(".slot-note");
            if (titleEl && cfg.label) titleEl.textContent = cfg.label;
            if (noteEl && cfg.note)   noteEl.textContent  = cfg.note;
          });

          // ãƒ˜ãƒƒãƒ€ãƒ¼ nav
          const nav = document.querySelector(".nav");
          if (nav) {
            nav.innerHTML = "";
            timeSlotConfigs.forEach((cfg) => {
              const a = document.createElement("a");
              a.href = `#${cfg.id}`;
              a.textContent = cfg.label || cfg.id;
              nav.appendChild(a);
            });
          }

          // ä»Šã‚„ã£ã¦ã„ã‚‹æ™‚é–“å¸¯åˆ¤å®šã«ã‚‚åæ˜ 
          setDynamicTimeSlots(timeSlotConfigs);
        }

        async function loadTimeSlotsConfig() {
          try {
            const doc = await storeRef.collection("settings").doc("timeSlots").get();
            if (doc.exists) {
              const data = doc.data() || {};
              const slots = Array.isArray(data.slots) ? data.slots : [];
              if (slots.length) {
                // Firestore ã® slots ã‚’å„ªå…ˆ
                timeSlotConfigs = slots.map((s, index) => {
                  const base = timeSlotConfigs[index] || {};
                  const id = s.id || s.slotId || base.id || `slot${index + 1}`;
                  const label = s.label || s.title || base.label || id;
                  const note  = s.note  || s.subtitle || base.note  || "";
                  const fromHour = Number(
                    s.fromHour ?? s.startHour ?? s.from ?? s.start ?? base.fromHour ?? 0
                  );
                  const toHour = Number(
                    s.toHour ?? s.endHour ?? s.to ?? s.end ?? base.toHour ?? 0
                  );
                  return { id, label, note, fromHour, toHour };
                });
              }
            }
          } catch (e) {
            console.error("timeSlots è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
          }

          // timeSlots ã®æ•°ã ã‘ã‚«ãƒ¼ãƒ‰ã‚’å¢—ã‚„ã™
          ensureSlotSectionCount(timeSlotConfigs.length);

          timeSlotIds = timeSlotConfigs.map((s) => s.id);
          applyTimeSlotsToUI();
        }

        // ã‚¿ã‚¹ã‚¯å®šç¾© & ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
        const checkboxMap = new Map();
        let latestCheckedIds = new Set();

        const taskDocRef = storeRef.collection("tasks").doc("main");
        let applyingRemote = false;

        // å®Œäº†ç‡ãƒãƒ¼ä½œæˆ
        function initializeProgressBars() {
          timeSlotIds.forEach((slotId) => {
            const section = document.getElementById(slotId);
            if (!section) return;
            const header = section.querySelector(".slot-header");
            if (!header) return;
            if (section.querySelector(".slot-progress")) return;

            const wrap = document.createElement("div");
            wrap.className = "slot-progress";
            wrap.innerHTML = `
              <div class="slot-progress-label" data-slot-progress-label="${slotId}">
                å®Œäº†ï¼š0/0ï¼ˆ0%ï¼‰
              </div>
              <div class="slot-progress-bar">
                <div class="slot-progress-bar-inner" data-slot-progress-bar="${slotId}"></div>
              </div>
            `;
            header.insertAdjacentElement("afterend", wrap);
          });
        }

        function updateCompletionUI() {
          timeSlotIds.forEach((slotId) => {
            let total = 0;
            let done = 0;

            checkboxMap.forEach((cb, id) => {
              if (id.startsWith(slotId + "-")) {
                total++;
                if (cb.checked) done++;
              }
            });

            const rate = total > 0 ? Math.round((done / total) * 100) : 0;

            const labelEl = document.querySelector(
              `[data-slot-progress-label="${slotId}"]`
            );
            const barEl = document.querySelector(
              `[data-slot-progress-bar="${slotId}"]`
            );

            if (labelEl) {
              labelEl.textContent = `å®Œäº†ï¼š${done}/${total}ï¼ˆ${rate}%ï¼‰`;
            }
            if (barEl) {
              barEl.style.width = `${rate}%`;
            }
          });
        }

        // =============================
// ã‚¿ã‚¹ã‚¯æç”»ã¾ã‚ã‚Šï¼ˆAå†™çœŸå¿…é ˆï¼‹Bã‚¿ã‚¹ã‚¯ï¼‰
// =============================

// â˜… æ±ç”¨ã‚¿ã‚¹ã‚¯æç”»ï¼ˆä¸»ã« Bã‚¿ã‚¹ã‚¯ç”¨ï¼‰
function buildTasksFromDefinition(slotId, ul, tasks, groupLabel) {
  ul.innerHTML = "";
  tasks.forEach((text, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <label class="task-item">
        <input type="checkbox">
        <span class="task-text"></span>
      </label>
    `;
    const cb   = li.querySelector('input[type="checkbox"]');
    const span = li.querySelector(".task-text");
    span.textContent = text;

    const taskId = `${slotId}-${groupLabel}-${index}`;
    cb.dataset.taskId = taskId;
    checkboxMap.set(taskId, cb);
    cb.checked = latestCheckedIds.has(taskId);
    ul.appendChild(li);
  });
}

// â˜… Aã‚¿ã‚¹ã‚¯å°‚ç”¨ï¼šå†™çœŸå¿…é ˆå¯¾å¿œç‰ˆ
function buildATasksWithPhoto(slotId, ulA, photoTasks, tasksA) {
  ulA.innerHTML = "";

  const photoList    = Array.isArray(photoTasks) ? photoTasks : [];
  const requiredList = Array.isArray(tasksA)     ? tasksA     : [];

  // â‘  å†™çœŸå¿…é ˆã‚¿ã‚¹ã‚¯ã‹ã‚‰å…ˆã«ä¸¦ã¹ã‚‹
  photoList.forEach((text, index) => {
    const li = document.createElement("li");
    li.className = "task-item";
    li.dataset.slotId = slotId;
    li.dataset.taskType = "A";
    li.dataset.photoRequired = "1";
    li.dataset.taskLabel = text;

    const taskId = `${slotId}-AP-${index}`; // AP = A Photo ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
    const isDone = latestCheckedIds.has(taskId);

    li.innerHTML = `
      <div class="task-main-row">
        <label class="task-main-label">
          <input
            type="checkbox"
            class="task-checkbox"
            data-task-id="${taskId}"
            data-photo-lock="1"
            ${isDone ? "checked" : ""}
          >
          <span class="task-text"></span>
          <span class="badge badge-photo">å†™çœŸå¿…é ˆ</span>
        </label>
      </div>
      <div class="task-photo-area">
        <input type="file" accept="image/*" capture="environment" class="task-photo-input">
        <button type="button" class="task-photo-upload-btn">å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <div class="task-photo-status"></div>
      </div>
    `;

    const cb   = li.querySelector('input[type="checkbox"]');
    const span = li.querySelector(".task-text");
    span.textContent = text;

    // â˜…ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åæ˜ 
    if (isDone) {
      cb.dataset.photoUploaded = "1";
      cb.dataset.photoLock = "0";
    } else {
      cb.dataset.photoUploaded = "0";
      cb.dataset.photoLock = "1";
    }

    checkboxMap.set(taskId, cb);
    ulA.appendChild(li);
  });

  // â‘¡ æ™®é€šã® Aã‚¿ã‚¹ã‚¯ï¼ˆãƒã‚§ãƒƒã‚¯ã®ã¿ï¼‰
  requiredList.forEach((text, index) => {
    const li = document.createElement("li");
    li.className = "task-item";
    li.dataset.slotId = slotId;
    li.dataset.taskType = "A";
    li.dataset.taskLabel = text;

    const taskId = `${slotId}-A-${index}`;
    const isDone = latestCheckedIds.has(taskId);

    li.innerHTML = `
      <div class="task-main-row">
        <label class="task-main-label">
          <input
            type="checkbox"
            class="task-checkbox"
            data-task-id="${taskId}"
            ${isDone ? "checked" : ""}
          >
          <span class="task-text"></span>
        </label>
      </div>
    `;

    const cb   = li.querySelector('input[type="checkbox"]');
    const span = li.querySelector(".task-text");
    span.textContent = text;

    checkboxMap.set(taskId, cb);
    ulA.appendChild(li);
  });
}

// â˜… Firestore ã‹ã‚‰ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå†™çœŸå¯¾å¿œç‰ˆï¼‰
async function loadTaskDefinitions() {
  const taskSlotsRef = storeRef.collection("taskSlots");
  await Promise.all(
    timeSlotIds.map(async (slotId) => {
      const section = document.getElementById(slotId);
      if (!section) return;
      const ulA = section.querySelector("ul.tasks.a");
      const ulB = section.querySelector("ul.tasks.b");
      if (!ulA || !ulB) return;

      try {
        const snap = await taskSlotsRef.doc(slotId).get();
        if (snap.exists) {
          const data = snap.data() || {};

          // ğŸ†• owner.html ã§ä¿å­˜ã—ã¦ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã‚€
          const photoTasks = data.tasksPhoto || data.photoTasks || [];
          const tasksA     = data.tasksA     || [];
          const tasksB     = data.tasksB     || [];

          // ğŸ†• Aã‚¿ã‚¹ã‚¯ï¼šå†™çœŸå¿…é ˆï¼‹æ™®é€šã®å¿…é ˆã‚’ã¾ã¨ã‚ã¦æç”»
          buildATasksWithPhoto(slotId, ulA, photoTasks, tasksA);

          // Bã‚¿ã‚¹ã‚¯ã¯ä»Šã¾ã§é€šã‚Š
          buildTasksFromDefinition(slotId, ulB, tasksB, "B");
        } else {
          // Firestoreã«å®šç¾©ãŒãªã„ã¨ãã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—¢å­˜liã‚’ãã®ã¾ã¾æ´»ç”¨ï¼‰
          const setupFromExisting = (ul, groupLabel) => {
            ul.querySelectorAll("li").forEach((li, index) => {
              const cb = li.querySelector('input[type="checkbox"]');
              if (!cb) return;
              const taskId = `${slotId}-${groupLabel}-${index}`;
              cb.dataset.taskId = taskId;
              checkboxMap.set(taskId, cb);
              cb.checked = latestCheckedIds.has(taskId);
            });
          };
          setupFromExisting(ulA, "A");
          setupFromExisting(ulB, "B");
        }
      } catch (e) {
        console.error("ã‚¿ã‚¹ã‚¯å®šç¾©èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", slotId, e);
      }
    })
  );
}



        function saveTasksToFirestore() {
          const checkedIds = [];
          checkboxMap.forEach((cb, id) => {
            if (cb.checked) checkedIds.push(id);
          });
          const businessKey = getCurrentBusinessKey();
          taskDocRef.set(
            { checkedIds, businessKey },
            { merge: true }
          );
        }

        taskDocRef.onSnapshot((doc) => {
          const data = doc.exists ? doc.data() : {};
          const storedKey  = data.businessKey;
          const currentKey = getCurrentBusinessKey();

          if (storedKey !== currentKey) {
            taskDocRef.set(
              { checkedIds: [], businessKey: currentKey },
              { merge: true }
            );
            latestCheckedIds = new Set();
          } else {
            latestCheckedIds = new Set(data.checkedIds || []);
          }

          applyingRemote = true;
          checkboxMap.forEach((cb, id) => {
            cb.checked = latestCheckedIds.has(id);
          });
          applyingRemote = false;

          updateCompletionUI();
        });

        // ãƒ­ã‚°å…±é€šé–¢æ•°
        async function logChecklistAction({ taskId, taskLabel, action, extra }) {
          try {
            const now = new Date();
            const businessKey = getCurrentBusinessKey();
            const rawLabel =
              (localStorage.getItem("nb_lawson_device_label") || "") ||
              (localStorage.getItem("staffName") || "");
            const deviceLabel =
              rawLabel && rawLabel.trim() ? rawLabel.trim() : "æœªè¨­å®š";

            await storeRef.collection("checklistLogs").add({
              taskId: taskId ?? null,
              taskLabel: taskLabel ?? null,
              action,
              deviceLabel,
              businessKey,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              clientTimeISO: now.toISOString(),
              extra: extra ?? null
            });
          } catch (err) {
            console.error("ãƒ­ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", err);
          }
        }

        // ãƒã‚§ãƒƒã‚¯ â†’ Firestore + ãƒ­ã‚°
        document.body.addEventListener("change", (e) => {
  const target = e.target;
  if (!target.matches('input[type="checkbox"][data-task-id]')) return;

  // ğŸ†• å†™çœŸå¿…é ˆã‚¿ã‚¹ã‚¯ã¯ã€å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒçµ‚ã‚ã‚‹ã¾ã§ãƒ­ãƒƒã‚¯
  if (target.dataset.photoLock === "1" && target.dataset.photoUploaded !== "1") {
    // ã¾ã å†™çœŸãŒã‚¢ãƒƒãƒ—ã•ã‚Œã¦ãªã„
    e.preventDefault?.();
    target.checked = false;
    alert("ã“ã®ã‚¿ã‚¹ã‚¯ã¯å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ã€‚\nå…ˆã«å†™çœŸã‚’ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (applyingRemote) return;

  saveTasksToFirestore();
  updateCompletionUI();

  const taskId = target.dataset.taskId || null;
  const taskLabel =
    target.closest(".task-item")?.querySelector(".task-text")?.textContent || null;

  logChecklistAction({
    taskId,
    taskLabel,
    action: target.checked ? "check" : "uncheck"
  });
});





// ğŸ†• å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®å‡¦ç† â†â˜…â˜… ã“ã“ã‚’ä»Šã‹ã‚‰è¿½åŠ 
document.body.addEventListener("click", async (e) => {
  const btn = e.target.closest(".task-photo-upload-btn");
  if (!btn) return;

  const li = btn.closest(".task-item");
  if (!li) return;

  const fileInput  = li.querySelector(".task-photo-input");
  const statusEl   = li.querySelector(".task-photo-status");
  const checkbox   = li.querySelector('input[type="checkbox"][data-task-id]');
  const taskTextEl = li.querySelector(".task-text");

  if (!fileInput || !checkbox || !taskTextEl) return;

  const file = fileInput.files[0];
  if (!file) {
    alert("å…ˆã«å†™çœŸã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  if (!STORE_ID || !storeRef) {
    alert("åº—èˆ—æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const slotId      = li.dataset.slotId || "unknown";
  const taskLabel   = li.dataset.taskLabel || taskTextEl.textContent || "";
  const businessKey = getCurrentBusinessKey();

  try {
    btn.disabled = true;
    btn.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
    if (statusEl) statusEl.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";

    // === Storage ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===
    const path = `stores/${STORE_ID}/photoTasks/${businessKey}/${slotId}/${Date.now()}_${Math.random().toString(36).slice(2)}_${file.name}`;
    const storageRefPath = storage.ref().child(path);

    await storageRefPath.put(file);
    const downloadUrl = await storageRefPath.getDownloadURL();

    // === Firestore ã«ã‚‚è¨˜éŒ²ï¼ˆnotice.html ç”¨ï¼‰ ===
    await storeRef.collection("photoReports").add({
      slotId,
      taskLabel,
      photoUrl: downloadUrl,
      businessKey,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      deviceLabel: currentDeviceLabel || "æœªè¨­å®š",
    });

    // === ãƒã‚§ãƒƒã‚¯ã‚’è§£ç¦ï¼†è‡ªå‹•ãƒã‚§ãƒƒã‚¯ ===
    checkbox.dataset.photoUploaded = "1";
    checkbox.dataset.photoLock = "0";
    checkbox.checked = true;

    saveTasksToFirestore();
    updateCompletionUI();

    logChecklistAction({
      taskId: checkbox.dataset.taskId || null,
      taskLabel,
      action: "photoUploaded",
      extra: { photoUrl: downloadUrl },
    });

    fileInput.value = "";
    if (statusEl) statusEl.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†";
    btn.textContent = "å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰";

  } catch (err) {
    console.error("å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼", err);
    alert("å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    if (statusEl) statusEl.textContent = "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—";
  } finally {
    btn.disabled = false;
  }
});




        

        // å¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆå…±é€šï¼‰
        const handoverSlots  = document.querySelectorAll(".handover-slot");
        const handoverColRef = storeRef.collection("handover");

        handoverSlots.forEach((slotEl) => {
          const slotId    = slotEl.dataset.slot || "global";
          const logEl     = slotEl.querySelector(".handover-log");
          const clearBtn  = slotEl.querySelector(".handover-clear-btn");
          const chipsArea = slotEl.querySelector(".handover-chips");

          // è¡¨ç¤º
          handoverColRef
            .where("businessKey", "==", getCurrentBusinessKey())
            .where("slotId", "==", slotId)
            .onSnapshot((snapshot) => {
              if (!logEl) return;
              logEl.innerHTML = "";

              if (snapshot.empty) {
                const li = document.createElement("li");
                li.textContent = "ã¾ã å¼•ãç¶™ããƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                li.style.fontSize = "0.9em";
                li.style.color = "#999";
                logEl.appendChild(li);
                return;
              }

              const docs = [];
              snapshot.forEach((doc) => docs.push(doc));
              docs.sort((a, b) => {
                const da = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
                const db = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
                return db - da;
              });

              docs.forEach((doc) => {
                const data = doc.data();
                const li = document.createElement("li");
                li.className = "handover-item";

                const textSpan = document.createElement("span");
                textSpan.className = "handover-text";
                textSpan.textContent = data.text || "";

                const timeSpan = document.createElement("span");
                timeSpan.className = "handover-time";
                const t = data.timeLabel || "";
                const name = data.deviceLabel || "";
                timeSpan.textContent = name ? `${t} / ${name}` : t;

                const delBtn = document.createElement("button");
                delBtn.className = "handover-remove";
                delBtn.textContent = "âœ•";
                delBtn.addEventListener("click", () => {
                  doc.ref.delete();
                });

                li.appendChild(textSpan);
                li.appendChild(timeSpan);
                li.appendChild(delBtn);
                logEl.appendChild(li);
              });
            });

          function addHandoverForSlot(text) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString("ja-JP", {
              hour: "2-digit",
              minute: "2-digit"
            });
            const businessKey = getCurrentBusinessKey();
            handoverColRef.add({
              text,
              slotId,
              businessKey,
              timeLabel,
              deviceLabel: currentDeviceLabel || "æœªè¨­å®š",
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }

          // ãƒãƒƒãƒ—ï¼ˆglobalãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
          if (chipsArea) {
            storeRef.collection("handoverTemplates").doc("global").get()
              .then((doc) => {
                chipsArea.innerHTML = "";
                if (!doc.exists) return;

                const chips = doc.data().chips || [];
                const PRIMARY_COUNT = 10;

                const primaryContainer = document.createElement("div");
                primaryContainer.className = "handover-chips-primary";

                const extraContainer = document.createElement("div");
                extraContainer.className = "handover-chips-extra is-hidden";

                chipsArea.appendChild(primaryContainer);

                let toggleBtn = null;
                if (chips.length > PRIMARY_COUNT) {
                  toggleBtn = document.createElement("button");
                  toggleBtn.className = "handover-chips-toggle";
                  toggleBtn.innerHTML = `
                    <span class="arrow">â–¼</span>
                    <span class="label">ã‚‚ã£ã¨è¡¨ç¤º</span>
                  `;
                  toggleBtn.addEventListener("click", () => {
                    const isHidden = extraContainer.classList.toggle("is-hidden");
                    if (isHidden) {
                      toggleBtn.classList.remove("open");
                      toggleBtn.querySelector(".label").textContent = "ã‚‚ã£ã¨è¡¨ç¤º";
                    } else {
                      toggleBtn.classList.add("open");
                      toggleBtn.querySelector(".label").textContent = "é–‰ã˜ã‚‹";
                    }
                  });
                  chipsArea.appendChild(toggleBtn);
                }

                chipsArea.appendChild(extraContainer);

                chips.forEach((text, index) => {
                  const btn = document.createElement("button");
                  btn.className = "handover-chip";
                  btn.textContent = text;
                  btn.dataset.text = text;
                  btn.addEventListener("click", () => {
                    addHandoverForSlot(text);
                  });

                  if (index < PRIMARY_COUNT) {
                    primaryContainer.appendChild(btn);
                  } else {
                    extraContainer.appendChild(btn);
                  }
                });
              })
              .catch((err) => {
                console.error("handoverTemplates èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", err);
              });
          }

          // å…¨æ¶ˆã—
          if (clearBtn) {
            clearBtn.addEventListener("click", async () => {
              if (!confirm("ä»Šæ—¥ã®å¼•ãç¶™ããƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
              const businessKey = getCurrentBusinessKey();
              const snap = await handoverColRef
                .where("slotId", "==", slotId)
                .where("businessKey", "==", businessKey)
                .get();
              if (snap.empty) return;
              const batch = db.batch();
              snap.forEach((doc) => batch.delete(doc.ref));
              await batch.commit();
            });
          }
        });

                // çµŒå–¶è€…ãŠçŸ¥ã‚‰ã›ï¼ˆownerNewsï¼‰
        const infoListEl = document.querySelector(".info-list");
        const noticeStatusBadge = document.getElementById("notice-status-badge");
        const noticeReadBtn = document.getElementById("notice-read-btn");
        const NOTICE_LAST_READ_KEY = "noticeLastReadAt";
        let latestNoticeMs = 0;

        function updateNoticeBadge() {
          if (!noticeStatusBadge || latestNoticeMs === 0) return;

          const lastReadStr = localStorage.getItem(NOTICE_LAST_READ_KEY);
          const lastReadMs = lastReadStr ? Number(lastReadStr) : 0;
          const hasUnread = lastReadMs < latestNoticeMs;

          if (hasUnread) {
            noticeStatusBadge.textContent = "æœªèª­ã‚ã‚Š";
            noticeStatusBadge.classList.add("unread");
            noticeStatusBadge.classList.remove("read");
          } else {
            noticeStatusBadge.textContent = "ã™ã¹ã¦ç¢ºèªæ¸ˆã¿";
            noticeStatusBadge.classList.add("read");
            noticeStatusBadge.classList.remove("unread");
          }
        }

        if (infoListEl) {
          const ownerNewsColRef = storeRef.collection("ownerNews");
          ownerNewsColRef
            .orderBy("createdAt", "desc")
            .limit(5)
            .onSnapshot(
              (snapshot) => {
                infoListEl.innerHTML = "";
                latestNoticeMs = 0;

                if (snapshot.empty) {
                  const li = document.createElement("li");
                  li.textContent = "ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                  infoListEl.appendChild(li);
                  updateNoticeBadge();
                  return;
                }

                snapshot.forEach((doc) => {
                  const data = doc.data();
                  const title = data.title || "";
                  const body  = data.body  || "";
                  const li = document.createElement("li");
                  if (title && body) {
                    li.textContent = `ã€${title}ã€‘ ${body}`;
                  } else if (title) {
                    li.textContent = `ã€${title}ã€‘`;
                  } else {
                    li.textContent = body || "";
                  }
                  infoListEl.appendChild(li);

                  if (data.createdAt) {
                    const ms = data.createdAt.toMillis();
                    if (ms > latestNoticeMs) latestNoticeMs = ms;
                  }
                });

                updateNoticeBadge();
              },
              (error) => {
                console.error("ownerNews èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", error);
                infoListEl.innerHTML = "";
                const li = document.createElement("li");
                li.textContent = "ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                infoListEl.appendChild(li);
              }
            );
        }

        if (noticeReadBtn) {
          noticeReadBtn.addEventListener("click", () => {
            if (!latestNoticeMs) {
              alert("ãŠçŸ¥ã‚‰ã›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
              return;
            }

            const prevStr = localStorage.getItem(NOTICE_LAST_READ_KEY);
            const prevMs = prevStr ? Number(prevStr) : 0;
            const hadUnread = prevMs < latestNoticeMs;

            localStorage.setItem(NOTICE_LAST_READ_KEY, String(latestNoticeMs));
            updateNoticeBadge();

            if (hadUnread) {
              logChecklistAction({
                taskId: "ownerNews",
                taskLabel: "ãŠçŸ¥ã‚‰ã›ã‚’æ—¢èª­ã«ã—ãŸ",
                action: "noticeRead",
                extra: { latestNoticeMs }
              });
            }
          });
        }

        // =============================
        // ğŸ”‘ ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ï¼ˆview-authï¼‰
        // =============================
        const newStaffPassInput  = document.getElementById("newStaffPassInput");
        const changeStaffPassBtn = document.getElementById("changeStaffPassBtn");
        const changeStaffPassMsg = document.getElementById("changeStaffPassMsg");

        if (changeStaffPassBtn && newStaffPassInput && changeStaffPassMsg) {
          changeStaffPassBtn.addEventListener("click", async (e) => {
            e.preventDefault();

            const newPass = newStaffPassInput.value.trim();
            if (!newPass) {
              changeStaffPassMsg.textContent = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
              changeStaffPassMsg.className = "status err";
              return;
            }

            if (!storeRef) {
              changeStaffPassMsg.textContent =
                "åº—èˆ—æƒ…å ±ãŒã¾ã èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
              changeStaffPassMsg.className = "status err";
              return;
            }

            try {
              changeStaffPassMsg.textContent = "æ›´æ–°ä¸­â€¦";
              changeStaffPassMsg.className = "status";

              await storeRef
                .collection("settings")
                .doc("auth")
                .set(
                  {
                    staffPassword: newPass,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                  },
                  { merge: true }
                );

              changeStaffPassMsg.textContent =
                "ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚";
              changeStaffPassMsg.className = "status ok";
              newStaffPassInput.value = "";
            } catch (err) {
              console.error("ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ã‚¨ãƒ©ãƒ¼", err);
              changeStaffPassMsg.textContent =
                "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
              changeStaffPassMsg.className = "status err";
            }
          });
        }

        // =============================
        // â‘¡ reportsï¼ˆã‚¹ã‚¿ãƒƒãƒ• â†’ çµŒå–¶è€…ï¼‰ä¸€è¦§
        // =============================
        const adminReportsList  = document.getElementById("adminReportsList");
        const adminReportsEmpty = document.getElementById("adminReportsEmpty");

        function formatReportDate(ts) {
          if (!ts || !ts.toDate) return "";
          const d = ts.toDate();
          const yyyy = d.getFullYear();
          const mm   = String(d.getMonth() + 1).padStart(2, "0");
          const dd   = String(d.getDate()).padStart(2, "0");
          const hh   = String(d.getHours()).padStart(2, "0");
          const mi   = String(d.getMinutes()).padStart(2, "0");
          return `${yyyy}/${mm}/${dd} ${hh}:${mi}`;
        }

        if (adminReportsList) {
          storeRef
            .collection("reports")
            .orderBy("createdAt", "desc")
            .limit(100)
            .onSnapshot(
              (snap) => {
                adminReportsList.innerHTML = "";

                if (snap.empty) {
                  if (adminReportsEmpty) adminReportsEmpty.style.display = "block";
                  return;
                }
                if (adminReportsEmpty) adminReportsEmpty.style.display = "none";

                snap.forEach((doc) => {
                  const data = doc.data() || {};

                  const cat    = data.category || "ãã®ä»–";
                  const msg    = (data.message || "").replace(/\n/g, "<br>");
                  const name   = data.staffName || "ï¼ˆä¸æ˜ï¼‰";
                  const status = data.status || "æœªå¯¾å¿œ";
                  const dateText = data.createdAt
                    ? formatReportDate(data.createdAt)
                    : "";

                  const item = document.createElement("div");
                  item.className = "report-item";

                  item.innerHTML = `
                    <div class="report-header">
                      <span class="badge">ã‚«ãƒ†ã‚´ãƒª: ${cat}</span>
                      <span class="badge badge-status">${status}</span>
                    </div>
                    <div class="report-body">${msg}</div>
                    <div class="report-meta">
                      <span>é€ä¿¡è€…ï¼š${name}</span>
                      <span>${dateText}</span>
                    </div>
                    <div class="report-actions">
                      <button type="button"
                              class="btn-report-small js-report-done">
                        å¯¾å¿œæ¸ˆã¿ã«ã™ã‚‹
                      </button>
                      <button type="button"
                              class="btn-report-small btn-report-delete js-report-delete">
                        å‰Šé™¤
                      </button>
                    </div>
                  `;

                  const doneBtn   = item.querySelector(".js-report-done");
                  const deleteBtn = item.querySelector(".js-report-delete");

                  // ã€Œå¯¾å¿œæ¸ˆã¿ã«ã™ã‚‹ã€ãƒœã‚¿ãƒ³
                  doneBtn.addEventListener("click", async () => {
                    try {
                      await storeRef
                        .collection("reports")
                        .doc(doc.id)
                        .update({
                          status: "å¯¾å¿œæ¸ˆã¿",
                          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                    } catch (err) {
                      console.error("status æ›´æ–°ã‚¨ãƒ©ãƒ¼:", err);
                      alert("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                  });

                  // ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³
                  deleteBtn.addEventListener("click", async () => {
                    const ok = window.confirm("ã“ã®å ±å‘Šã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
                    if (!ok) return;

                    try {
                      await storeRef
                        .collection("reports")
                        .doc(doc.id)
                        .delete();
                    } catch (err) {
                      console.error("reports å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", err);
                      alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                  });

                  adminReportsList.appendChild(item);
                });
              },
              (err) => {
                console.error("reports èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
                if (adminReportsEmpty) {
                  adminReportsEmpty.textContent = "å ±å‘Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                  adminReportsEmpty.style.display = "block";
                }
              }
            );
        }

        // â˜… ã“ã“ã§ timeSlots ã‚’èª­ã¿è¾¼ã¿ â†’ ãã®å¾Œã«ãƒãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã‚’æ§‹ç¯‰
        loadTimeSlotsConfig().then(() => {
          initializeProgressBars();
          loadTaskDefinitions().then(updateCompletionUI);
        });

        setupDailyResetAt7AM();
      } // startApp ã“ã“ã¾ã§










   // =============================
// ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³æŠ¼ä¸‹ï¼ˆIDå…¥åŠ›ç‰ˆï¼‰
// =============================
async function handleLogin() {
  // 1) å…¥åŠ›æ¬„ã®å€¤ã‚’å„ªå…ˆ
  const inputId = (loginStoreIdInput?.value || "").trim();
  // 2) å…¥åŠ›ãŒç©ºãªã‚‰ URL / ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰è£œå®Œ
  const id = inputId || resolveStoreId();
  const pass = (loginStorePassInput?.value || "").trim();

  if (!id) {
    alert("åº—èˆ—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  if (!pass) {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  try {
    const storeDocRef = db.collection("stores").doc(id);

    // ğŸ”‘ Firestore å´ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆowner.htmlã§å¤‰æ›´å¯èƒ½ï¼‰
    const authSnap = await storeDocRef
      .collection("settings")
      .doc("auth")
      .get();

    let expected = null;

    // Firestore â†’ ã¾ãšå„ªå…ˆ
    if (authSnap.exists) {
      const authData = authSnap.data() || {};
      if (authData.staffPassword) {
        expected = authData.staffPassword;
      }
    }

    // Firestoreã«ã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ â†’ å®šæ•°(STORE_PASSWORDS)ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!expected) {
      expected = STORE_PASSWORDS[id] || null;
    }

    if (!expected) {
      alert("ã“ã®åº—èˆ—ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }

    if (pass !== expected) {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
      return;
    }

    // ğŸ‰ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼
    STORE_ID = id;
    storeRef = storeDocRef;
    saveLoginCache(STORE_ID);

    showApp();
    setAppReady();
    startApp();

  } catch (err) {
    console.error("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:", err);
    alert("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
  }
}







      if (loginBtn) {
        loginBtn.addEventListener("click", handleLogin);
      }
      if (loginStorePassInput) {
        loginStorePassInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            handleLogin();
          }
        });
      }













// â˜… ã‚¹ã‚¿ãƒƒãƒ•ç”¨ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆåº—èˆ—åˆ‡ã‚Šæ›¿ãˆï¼‰
      const staffLogoutBtn = document.getElementById("staffLogoutBtn");
      if (staffLogoutBtn) {
        staffLogoutBtn.addEventListener("click", () => {
          try {
            // ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™
            localStorage.removeItem(STORE_ID_CACHE_KEY);
            localStorage.removeItem(STORE_ID_TIME_KEY);

            // ç«¯æœ«ãƒ©ãƒ™ãƒ«ã‚„æ–‡å­—ã‚µã‚¤ã‚ºã‚‚ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã—ãŸã„ãªã‚‰ clear
            // â€»æ®‹ã—ãŸã„ãªã‚‰ä¸Šã®2è¡Œã ã‘ã§ã‚‚OK
            localStorage.clear();
          } catch (e) {
            console.warn("localStorage clear error:", e);
          }

          // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
          location.reload();
        });
      }

















// =============================
// è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š
// =============================
const cachedId = getCachedLoginStoreId();
if (cachedId) {
  // âœ… 15æ™‚é–“ä»¥å†…ãªã‚‰å‰å›ãƒ­ã‚°ã‚¤ãƒ³åº—èˆ—ã§ãã®ã¾ã¾å…¥ã‚‹
  STORE_ID = cachedId;
  storeRef = db.collection("stores").doc(STORE_ID);

  showApp();
  setAppReady();
  startApp();
} else {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡ã„ â†’ ãµã¤ã†ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
  showLogin();
  setAppReady();
}




    });
  </script>
</body>
</html>

