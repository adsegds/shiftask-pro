<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>南部町ローソン 管理画面（オーナー用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.6;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* ===== 左サイドバー（タイミー風） ===== */
    .sidebar {
      width: 230px;
      background: #f7f7f8;
      border-right: 1px solid #ddd;
      padding: 12px 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: sticky;
      top: 0;
      align-self: flex-start;
    }

    .sidebar-header {
      padding: 4px 8px 6px;
    }
    .sidebar-store {
      font-size: 13px;
      font-weight: 600;
    }
    .sidebar-role {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-nav button {
      text-align: left;
      border-radius: 6px;
      border: none;
      padding: 7px 10px;
      font-size: 13px;
      background: transparent;
      cursor: pointer;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-nav button span.label {
      flex: 1;
    }
    .sidebar-nav button span.badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #eee;
      color: #666;
      margin-left: 4px;
      min-width: 16px;
      text-align: center;
    }

    .sidebar-nav button:hover {
      background: #e9eefc;
    }

    .sidebar-nav button.active {
      background: #1a73e8;
      color: #fff;
    }
    .sidebar-nav button.active span.badge {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 10px;
      color: #999;
      padding: 0 8px;
    }

    /* ===== 右メインエリア ===== */
    .main {
      flex: 1;
      padding: 16px 20px 24px;
    }

    .main-header {
      margin-bottom: 12px;
    }
    .main-header-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .main-header-sub {
      font-size: 12px;
      color: #666;
    }

    .view-panel {
      display: none;
    }
    .view-panel.active {
      display: block;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 15px;
      margin-bottom: 2px;
    }
    .card-sub {
      font-size: 11px;
      color: #777;
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    input[type="text"],
    textarea,
    select,
    input[type="date"] {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      background: #fff;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.5;
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus,
    input[type="date"]:focus {
      border-color: #111;
    }

    select {
      padding: 4px 8px;
      font-size: 13px;
      background: #fff;
    }

    /* A/Bタスクのtextareaは縦長にする */
    #tasksAInput,
    #tasksBInput {
      min-height: 220px;
    }

    .row {
      margin-bottom: 10px;
    }

    .hint {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    button {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      cursor: pointer;
    }
    .btn-primary {
      background: #111;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #f44;
      color: #fff;
    }

    .status {
      font-size: 12px;
      min-height: 18px;
      margin-top: 2px;
    }
    .status.ok {
      color: #007700;
    }
    .status.err {
      color: #cc0000;
    }

    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 10px 0;
    }

    /* ownerNews list */
    .news-list {
      list-style: none;
      font-size: 12px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .news-item {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      gap: 8px;
    }
    .news-main {
      flex: 1;
    }
    .news-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .news-body {
      font-size: 12px;
    }
    .news-meta {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }
    .news-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .slot-note {
      font-size: 11px;
      color: #666;
      margin-top: -2px;
      margin-bottom: 6px;
    }

    /* 引き継ぎメモ テンプレ preview */
    .handover-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      padding: 6px 4px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px dashed #ddd;
    }
    .handover-preview-chip {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #ddd;
      white-space: nowrap;
    }

    /* ===== スタッフログ ===== */
    .log-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
    }
    .log-filters label {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 0;
    }
    .log-filters input[type="date"],
    .log-filters input[type="text"] {
      width: auto;
    }

    .log-table-wrapper {
      margin-top: 10px;
      max-height: 70vh;
      overflow: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    .log-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .log-table th,
    .log-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
    }
    .log-table th {
      background: #f5f5f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        position: static;
      }
      .sidebar-header {
        flex: 1;
      }
      .sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: flex-end;
      }
      .sidebar-footer {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ================= 左メニュー ================= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-store">南部町ローソン</div>
        <div class="sidebar-role">オーナー管理画面</div>
      </div>

      <nav class="sidebar-nav">
        <button type="button" data-view="news" class="active">
          <span class="label">お知らせ管理</span>
          <span class="badge">ownerNews</span>
        </button>
        <button type="button" data-view="tasks">
          <span class="label">時間帯ごとのタスク編集</span>
          <span class="badge">taskSlots</span>
        </button>
        <button type="button" data-view="handover">
          <span class="label">引き継ぎメモ（ボタン編集）</span>
          <span class="badge">handoverTemplates</span>
        </button>
        <button type="button" data-view="logs">
          <span class="label">スタッフログ</span>
          <span class="badge" id="logBadge">0</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        この画面で設定した内容が、スタッフ用チェック画面に反映されます。
      </div>
    </aside>

    <!-- ================= 右メイン ================= -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">管理メニュー</div>
        <div class="main-header-sub">
          左のメニューから編集したい項目を選んでください。
        </div>
      </header>

      <!-- ① お知らせ管理 -->
      <section id="view-news" class="view-panel active">
        <section class="card" id="news-card">
          <h2>お知らせ管理（ownerNews）</h2>
          <p class="card-sub">
            スタッフ画面の「お知らせ」欄に表示される内容を登録・削除できます。
          </p>

          <div class="row">
            <label for="newsTitle">タイトル</label>
            <input type="text" id="newsTitle" placeholder="例）FF油交換について" />
          </div>
          <div class="row">
            <label for="newsBody">本文</label>
            <textarea id="newsBody" placeholder="例）今週は油交換の頻度を1日2回に増やしてください。夜勤帯で対応お願いします。"></textarea>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-primary" id="newsAddBtn">お知らせを追加</button>
            <button type="button" class="btn-secondary" id="newsClearFormBtn">入力をクリア</button>
          </div>
          <div class="status" id="newsStatus"></div>

          <hr>

          <p class="hint">※最新20件まで表示。古いものから順に削除してOKです。</p>
          <ul class="news-list" id="newsList"></ul>
        </section>
      </section>

      <!-- ② タスク定義編集 -->
      <section id="view-tasks" class="view-panel">
        <section class="card" id="tasks-card">
          <h2>時間帯ごとのタスク編集（taskSlots）</h2>
          <p class="card-sub">
            各時間帯の Aタスク（必須）・Bタスク（余裕）を編集できます。<br>
            スタッフ画面のチェックリストはここで定義された内容から自動生成されます。
          </p>

          <div class="row">
            <label for="slotSelect">編集する時間帯</label>
            <select id="slotSelect">
              <option value="t6-8">6:00〜8:00（朝の立ち上げ）</option>
              <option value="t9-11">9:00〜11:00（午前帯）</option>
              <option value="t12-14">12:00〜14:00（昼帯）</option>
              <option value="t15-17">15:00〜17:00（夕方前）</option>
              <option value="t18-20">18:00〜20:00（夕方〜夜）</option>
              <option value="t21-23">21:00〜23:00（夜帯）</option>
              <option value="t0-2">0:00〜2:00（深夜前半）</option>
              <option value="t3-5">3:00〜5:00（早朝）</option>
            </select>
            <p class="slot-note">時間帯を変更すると、その時間帯のタスク定義を Firestore から読み込みます。</p>
          </div>

          <div class="row">
            <label for="tasksAInput">Aタスク（必須）</label>
            <textarea id="tasksAInput" placeholder="例）&#10;CDC納品・片づけ（2便）&#10;ベーカリー納品・片づけ（2便）"></textarea>
            <div class="hint">1行につき1タスク。空行は無視されます。</div>
          </div>

          <div class="row">
            <label for="tasksBInput">Bタスク（余裕あれば）</label>
            <textarea id="tasksBInput" placeholder="例）&#10;店内・店頭ゴミ箱の清掃&#10;サービスコーナー清掃"></textarea>
            <div class="hint">1行につき1タスク。空行は無視されます。</div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="reloadSlotBtn">選択中の時間帯を再読み込み</button>
            <button type="button" class="btn-primary" id="saveSlotBtn">この内容で保存</button>
          </div>
          <div class="status" id="taskStatus"></div>

          <hr>

          <p class="hint">
            ※保存すると、その時間帯のチェック状態だけリセットされます（他の時間帯はそのまま）。<br>
            ※チェックリスト本体の HTML（スタッフ用画面）は書き換え不要です。この画面は定義だけをいじる役割。
          </p>
        </section>
      </section>

      <!-- ③ 引き継ぎメモ用ボタン編集 -->
      <section id="view-handover" class="view-panel">
        <section class="card" id="handover-card">
          <h2>引き継ぎメモ（ボタン文言の編集）</h2>
          <p class="card-sub">
            スタッフ画面の「引き継ぎメモ（全員で共有）」に並んでいるボタンの文言を編集できます。<br>
            今は全時間帯で共通のボタンセット（global）を使います。
          </p>

          <div class="row">
            <label for="handoverChipsInput">ボタン文言リスト</label>
            <textarea id="handoverChipsInput"
              placeholder="例）&#10;FFケース清掃済み&#10;ホット・常温FF 補充済み&#10;米飯・おにぎり 前陳＆整理済み"></textarea>
            <div class="hint">
              1行につき1ボタンになります。空行は無視されます。<br>
              保存すると、全ての時間帯の「引き継ぎメモボタン」がこの内容で上書きされます。
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="handoverReloadBtn">現在の設定を読み込み</button>
            <button type="button" class="btn-primary" id="handoverSaveBtn">この内容で保存</button>
          </div>
          <div class="status" id="handoverStatus"></div>

          <hr>

          <label>プレビュー</label>
          <div class="handover-preview" id="handoverPreview">
            <!-- JSでボタンイメージを表示 -->
          </div>

          <p class="hint" style="margin-top:6px;">
            ※スタッフ画面側では <code>handoverTemplates/global</code> の内容を読みにいきます。<br>
            ※スタッフ画面のHTMLでは、ボタン部分は空の <code>&lt;div class="handover-chips"&gt;&lt;/div&gt;</code> にしておいてください。
          </p>
        </section>
      </section>

      <!-- ④ スタッフログ -->
      <section id="view-logs" class="view-panel">
        <section class="card" id="logs-card">
          <h2>スタッフログ（checklistLogs）</h2>
          <p class="card-sub">
            チェックリスト操作の履歴を確認できます。<br>
            営業日・端末ラベルで絞り込みできます。
          </p>

          <div class="log-filters">
            <label>
              営業日：
              <input type="date" id="logDateFilter" />
            </label>
            <label>
              端末ラベル：
              <input type="text" id="logDeviceFilter" placeholder="例：レジ横iPad" />
            </label>
            <button type="button" class="btn-secondary" id="logFilterApplyBtn">絞り込み</button>
          </div>

          <div class="log-table-wrapper">
            <table class="log-table">
              <thead>
                <tr>
                  <th>時刻</th>
                  <th>営業日</th>
                  <th>端末</th>
                  <th>操作</th>
                  <th>タスク</th>
                </tr>
              </thead>
              <tbody id="logTableBody">
                <tr>
                  <td colspan="5">ログ読み込み中...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase 設定
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 営業日キー計算（6:00切り替え）
    function getCurrentBusinessKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = now.getDate();
      const base = new Date(y, m, d);

      // 0:00〜5:59 は前日扱い
      if (now.getHours() < 6) {
        base.setDate(base.getDate() - 1);
      }

      const yy = base.getFullYear();
      const mm = String(base.getMonth() + 1).padStart(2, "0");
      const dd = String(base.getDate()).padStart(2, "0");
      return yy + "-" + mm + "-" + dd;
    }

    // =============================
    // DOM 準備
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
      // -------------------------
      // 共通：ビュー切り替え
      // -------------------------
      const sidebarButtons = document.querySelectorAll(".sidebar-nav button");
      const panels = {
        news: document.getElementById("view-news"),
        tasks: document.getElementById("view-tasks"),
        handover: document.getElementById("view-handover"),
        logs: document.getElementById("view-logs")
      };

      function switchView(viewId) {
        Object.keys(panels).forEach((key) => {
          if (panels[key]) {
            panels[key].classList.toggle("active", key === viewId);
          }
        });

        sidebarButtons.forEach((btn) => {
          const v = btn.getAttribute("data-view");
          btn.classList.toggle("active", v === viewId);
        });

        if (viewId === "logs") {
          startLogsListener();
        }
      }

      sidebarButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const viewId = btn.getAttribute("data-view");
          switchView(viewId);
        });
      });

      switchView("news"); // 初期表示

      // =============================
      // ① お知らせ管理（ownerNews）
      // =============================
      const newsTitleEl = document.getElementById("newsTitle");
      const newsBodyEl = document.getElementById("newsBody");
      const newsAddBtn = document.getElementById("newsAddBtn");
      const newsClearFormBtn = document.getElementById("newsClearFormBtn");
      const newsStatusEl = document.getElementById("newsStatus");
      const newsListEl = document.getElementById("newsList");

      function setNewsStatus(msg, ok) {
        if (!newsStatusEl) return;
        newsStatusEl.textContent = msg || "";
        newsStatusEl.className = "status " + (ok ? "ok" : "err");
      }

      if (newsAddBtn) {
        newsAddBtn.addEventListener("click", async () => {
          const title = (newsTitleEl.value || "").trim();
          const body = (newsBodyEl.value || "").trim();

          if (!title && !body) {
            setNewsStatus("タイトルか本文のどちらかは入力してください。", false);
            return;
          }
          setNewsStatus("保存中...", true);

          try {
            await db.collection("ownerNews").add({
              title,
              body,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            setNewsStatus("お知らせを追加しました。", true);
            newsTitleEl.value = "";
            newsBodyEl.value = "";
          } catch (e) {
            console.error(e);
            setNewsStatus("保存に失敗しました。", false);
          }
        });
      }

      if (newsClearFormBtn) {
        newsClearFormBtn.addEventListener("click", () => {
          newsTitleEl.value = "";
          newsBodyEl.value = "";
          setNewsStatus("", true);
        });
      }

      if (newsListEl) {
        db.collection("ownerNews")
          .orderBy("createdAt", "desc")
          .limit(20)
          .onSnapshot(
            (snapshot) => {
              newsListEl.innerHTML = "";
              if (snapshot.empty) {
                const li = document.createElement("li");
                li.textContent = "登録されているお知らせはありません。";
                li.style.fontSize = "12px";
                li.style.color = "#777";
                newsListEl.appendChild(li);
                return;
              }

              snapshot.forEach((doc) => {
                const data = doc.data();
                const li = document.createElement("li");
                li.className = "news-item";

                const main = document.createElement("div");
                main.className = "news-main";

                const titleDiv = document.createElement("div");
                titleDiv.className = "news-title";
                titleDiv.textContent = data.title || "(タイトルなし)";

                const bodyDiv = document.createElement("div");
                bodyDiv.className = "news-body";
                bodyDiv.textContent = data.body || "";

                const metaDiv = document.createElement("div");
                metaDiv.className = "news-meta";
                let dateStr = "";
                if (data.createdAt && data.createdAt.toDate) {
                  const dt = data.createdAt.toDate();
                  dateStr = dt.toLocaleString("ja-JP", {
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit"
                  });
                }
                metaDiv.textContent = dateStr ? "登録日時: " + dateStr : "";

                main.appendChild(titleDiv);
                main.appendChild(bodyDiv);
                main.appendChild(metaDiv);

                const actions = document.createElement("div");
                actions.className = "news-actions";

                const delBtn = document.createElement("button");
                delBtn.type = "button";
                delBtn.className = "btn-danger";
                delBtn.textContent = "削除";
                delBtn.style.fontSize = "11px";
                delBtn.style.padding = "4px 10px";

                delBtn.addEventListener("click", async () => {
                  if (!confirm("このお知らせを削除しますか？")) return;
                  try {
                    await doc.ref.delete();
                  } catch (e) {
                    console.error(e);
                    alert("削除に失敗しました。");
                  }
                });

                actions.appendChild(delBtn);

                li.appendChild(main);
                li.appendChild(actions);

                newsListEl.appendChild(li);
              });
            },
            (error) => {
              console.error("ownerNews 読み込みエラー", error);
              newsListEl.innerHTML = "";
              const li = document.createElement("li");
              li.textContent = "お知らせ一覧の読み込みに失敗しました。";
              newsListEl.appendChild(li);
            }
          );
      }

      // =============================
      // ② taskSlots 編集
      // =============================
      const slotSelectEl = document.getElementById("slotSelect");
      const tasksAInputEl = document.getElementById("tasksAInput");
      const tasksBInputEl = document.getElementById("tasksBInput");
      const reloadSlotBtn = document.getElementById("reloadSlotBtn");
      const saveSlotBtn = document.getElementById("saveSlotBtn");
      const taskStatusEl = document.getElementById("taskStatus");
      const taskSlotsColRef = db.collection("taskSlots");
      const tasksDocRef = db.collection("tasks").doc("lawson-main");

      function setTaskStatus(msg, ok) {
        if (!taskStatusEl) return;
        taskStatusEl.textContent = msg || "";
        taskStatusEl.className = "status " + (ok ? "ok" : "err");
      }

      async function loadSlotDefinition(slotId) {
        setTaskStatus("読み込み中...", true);
        try {
          const snap = await taskSlotsColRef.doc(slotId).get();
          if (snap.exists) {
            const data = snap.data() || {};
            const tasksA = Array.isArray(data.tasksA) ? data.tasksA : [];
            const tasksB = Array.isArray(data.tasksB) ? data.tasksB : [];
            tasksAInputEl.value = tasksA.join("\n");
            tasksBInputEl.value = tasksB.join("\n");
          } else {
            // 定義なしなら空
            tasksAInputEl.value = "";
            tasksBInputEl.value = "";
          }
          setTaskStatus("読み込み完了", true);
        } catch (e) {
          console.error("taskSlots load error:", e);
          setTaskStatus("読み込みに失敗しました。", false);
        }
      }

      if (slotSelectEl) {
        loadSlotDefinition(slotSelectEl.value);
        slotSelectEl.addEventListener("change", () => {
          loadSlotDefinition(slotSelectEl.value);
        });
      }

      if (reloadSlotBtn) {
        reloadSlotBtn.addEventListener("click", () => {
          if (slotSelectEl) {
            loadSlotDefinition(slotSelectEl.value);
          }
        });
      }

      if (saveSlotBtn) {
        saveSlotBtn.addEventListener("click", async () => {
          const slotId = slotSelectEl.value;
          const linesA = tasksAInputEl.value.split("\n")
            .map((v) => v.trim())
            .filter((v) => v !== "");
          const linesB = tasksBInputEl.value.split("\n")
            .map((v) => v.trim())
            .filter((v) => v !== "");

          setTaskStatus("保存中...", true);

          try {
            // taskSlots を更新
            await taskSlotsColRef.doc(slotId).set(
              {
                tasksA: linesA,
                tasksB: linesB
              },
              { merge: true }
            );

            // その時間帯のチェック状態だけリセット
            const tasksSnap = await tasksDocRef.get();
            if (tasksSnap.exists) {
              const data = tasksSnap.data() || {};
              const oldIds = Array.isArray(data.checkedIds) ? data.checkedIds : [];
              const newIds = oldIds.filter((id) => !String(id).startsWith(slotId + "-"));
              await tasksDocRef.set(
                { checkedIds: newIds },
                { merge: true }
              );
            }

            setTaskStatus("保存しました。（この時間帯のチェックはリセット）", true);
          } catch (e) {
            console.error("taskSlots save error:", e);
            setTaskStatus("保存に失敗しました。", false);
          }
        });
      }

      // =============================
      // ③ handoverTemplates/global 編集
      // =============================
      const handoverChipsInputEl = document.getElementById("handoverChipsInput");
      const handoverReloadBtn = document.getElementById("handoverReloadBtn");
      const handoverSaveBtn = document.getElementById("handoverSaveBtn");
      const handoverStatusEl = document.getElementById("handoverStatus");
      const handoverPreviewEl = document.getElementById("handoverPreview");
      const handoverTplRef = db.collection("handoverTemplates").doc("global");

      function setHandoverStatus(msg, ok) {
        if (!handoverStatusEl) return;
        handoverStatusEl.textContent = msg || "";
        handoverStatusEl.className = "status " + (ok ? "ok" : "err");
      }

      function renderHandoverPreview(chips) {
        if (!handoverPreviewEl) return;
        handoverPreviewEl.innerHTML = "";
        if (!chips || !chips.length) {
          const span = document.createElement("span");
          span.textContent = "プレビューなし（ボタン未設定）";
          span.style.fontSize = "11px";
          span.style.color = "#999";
          handoverPreviewEl.appendChild(span);
          return;
        }
        chips.forEach((text) => {
          const chip = document.createElement("span");
          chip.className = "handover-preview-chip";
          chip.textContent = text;
          handoverPreviewEl.appendChild(chip);
        });
      }

      async function loadHandoverTemplate() {
        setHandoverStatus("読み込み中...", true);
        try {
          const snap = await handoverTplRef.get();
          if (snap.exists) {
            const data = snap.data() || {};
            const chips = Array.isArray(data.chips) ? data.chips : [];
            handoverChipsInputEl.value = chips.join("\n");
            renderHandoverPreview(chips);
          } else {
            handoverChipsInputEl.value = "";
            renderHandoverPreview([]);
          }
          setHandoverStatus("読み込み完了", true);
        } catch (e) {
          console.error("handoverTemplates load error:", e);
          setHandoverStatus("読み込みに失敗しました。", false);
        }
      }

      if (handoverReloadBtn) {
        handoverReloadBtn.addEventListener("click", () => {
          loadHandoverTemplate();
        });
      }

      if (handoverSaveBtn) {
        handoverSaveBtn.addEventListener("click", async () => {
          const chips = handoverChipsInputEl.value.split("\n")
            .map((v) => v.trim())
            .filter((v) => v !== "");

          setHandoverStatus("保存中...", true);
          try {
            await handoverTplRef.set(
              { chips },
              { merge: true }
            );
            renderHandoverPreview(chips);
            setHandoverStatus("保存しました。", true);
          } catch (e) {
            console.error("handoverTemplates save error:", e);
            setHandoverStatus("保存に失敗しました。", false);
          }
        });
      }

      // 初期読み込み（handover）
      loadHandoverTemplate();

      // =============================
      // ④ スタッフログ（checklistLogs）
      // =============================
      const logTableBody = document.getElementById("logTableBody");
      const logBadgeEl = document.getElementById("logBadge");
      const logDateFilterEl = document.getElementById("logDateFilter");
      const logDeviceFilterEl = document.getElementById("logDeviceFilter");
      const logFilterApplyBtn = document.getElementById("logFilterApplyBtn");

      let logsUnsub = null;
      let latestLogDocs = [];

      function toBusinessKeyFromDateInput(value) {
        if (!value) return null;
        return value; // そのまま YYYY-MM-DD 形式
      }

      function renderLogs(docs) {
        if (!logTableBody) return;
        logTableBody.innerHTML = "";

        if (!docs.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 5;
          td.textContent = "ログがありません。";
          tr.appendChild(td);
          logTableBody.appendChild(tr);
          return;
        }

        docs.forEach((doc) => {
          const data = doc.data();
          const tr = document.createElement("tr");

          // 時刻
          let timeStr = "-";
          if (data.createdAt && data.createdAt.toDate) {
            const dt = data.createdAt.toDate();
            timeStr = dt.toLocaleTimeString("ja-JP", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          } else if (data.clientTimeISO) {
            const dt = new Date(data.clientTimeISO);
            timeStr = dt.toLocaleTimeString("ja-JP", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          }

          const tdTime = document.createElement("td");
          tdTime.textContent = timeStr;

          const tdBiz = document.createElement("td");
          tdBiz.textContent = data.businessKey || "";

          const tdDevice = document.createElement("td");
          tdDevice.textContent = data.deviceLabel || "未設定";

          const tdAction = document.createElement("td");
          let actionLabel = data.action || "";
          if (data.action === "check") actionLabel = "✅ チェック";
          if (data.action === "uncheck") actionLabel = "⬜ チェック解除";
          tdAction.textContent = actionLabel;

          const tdTask = document.createElement("td");
          tdTask.textContent = data.taskLabel || data.taskId || "";

          tr.appendChild(tdTime);
          tr.appendChild(tdBiz);
          tr.appendChild(tdDevice);
          tr.appendChild(tdAction);
          tr.appendChild(tdTask);
          logTableBody.appendChild(tr);
        });
      }

      function applyLogFilters() {
        const bizFilter = toBusinessKeyFromDateInput(logDateFilterEl.value);
        const deviceFilter = (logDeviceFilterEl.value || "").trim();

        const filtered = latestLogDocs.filter((doc) => {
          const data = doc.data();
          if (bizFilter && data.businessKey !== bizFilter) return false;
          if (deviceFilter && !String(data.deviceLabel || "").includes(deviceFilter)) return false;
          return true;
        });

        renderLogs(filtered);
      }

      if (logFilterApplyBtn) {
        logFilterApplyBtn.addEventListener("click", () => {
          applyLogFilters();
        });
      }

      // 初回は本日営業日をデフォルトフィルターに
      if (logDateFilterEl) {
        logDateFilterEl.value = getCurrentBusinessKey();
      }

      function startLogsListener() {
        if (logsUnsub) return; // すでに開始済み

        logsUnsub = db.collection("checklistLogs")
          .orderBy("createdAt", "desc")
          .limit(200)
          .onSnapshot(
            (snapshot) => {
              latestLogDocs = [];
              snapshot.forEach((doc) => latestLogDocs.push(doc));

              if (logBadgeEl) {
                logBadgeEl.textContent = String(snapshot.size || 0);
              }

              applyLogFilters();
            },
            (error) => {
              console.error("スタッフログ読み込みエラー", error);
              if (logTableBody) {
                logTableBody.innerHTML =
                  '<tr><td colspan="5">ログの読み込みに失敗しました。</td></tr>';
              }
            }
          );
      }
    });
  </script>
</body>
</html>
